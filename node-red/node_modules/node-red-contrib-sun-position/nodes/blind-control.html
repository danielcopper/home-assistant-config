<!DOCTYPE HTML>
<!--
This code is licensed under the Apache License Version 2.0.

Copyright (c) 2022 Robert Gester

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:

1. Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.

2. Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.

3. Neither the name of the copyright holder nor the names of its
contributors may be used to endorse or promote products derived from
this software without specific prior written permission.

-->

<script type="text/javascript">
    (function() {
        const cNBC_MODE_OFF = 0;
        const cNBC_MODE_MAXIMIZE = 1;
        const cNBC_MODE_MINIMIZE = 3;
        const cNBC_MODE_SUN_CONTROL = 16;
        const cNBC_RULE_TYPE_UNTIL = 0;
        const cNBC_RULE_TYPE_FROM = 1;
        const cNBC_RULE_OP = {
            levelAbsolute : 0,
            levelMinOversteer : 1,  // ⭳❗ minimum (oversteer)
            levelMaxOversteer : 2, // ⭱️❗ maximum (oversteer)
            slatOversteer : 5,
            topicOversteer : 8,
            off : 9
        };

        /**
         * get a value
         * @param {*} node - the node representation
         * @param {string} name - name of the value
         * @returns {*} the value of th element
         */
        function getVal(node,name) {
            const v = $('#node-input-' + name).val();
            if (typeof v === 'undefined') {
                return node[name];
            }
            return v;
        }

        /**
         * get the min and maximum blind positions
         * @param {*} node - the node representation
         * @returns {object} object with property __min__ and __max__
         */
        function getMinMaxBlindPos(node) {
            const max = parseFloat(getVal(node, 'blindOpenPos')) || 0;
            const min = parseFloat(getVal(node, 'blindClosedPos')) || 0;
            return { min:Math.min(min, max), max:Math.max(min, max) };
        }

        RED.nodes.registerType('blind-control', {
            category: 'time and astro',
            color: '#FFCC66',
            icon: 'blind-white.svg',
            inputs: 1,
            outputs: 2,
            defaults: {
                name: {
                    value: '',
                    required: false
                },
                topic: {
                    value: '',
                    required: false
                },
                addIdType: {
                    value: 'none'
                },
                addId: {
                    value: '',
                    validate: RED.validators.typedInput('addIdType')
                },
                positionConfig: {
                    value: '',
                    type: 'position-config',
                    required: true
                },
                autoTrigger: { value: true },
                autoTriggerTime: {
                    value: 3600000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (RED.validators.number()(v) && (n >= 60000) && (n < 0x7FFFFFFF));
                    }
                },
                startDelayTime: {
                    value: 10000,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (RED.validators.number()(v) && (n >= 0) && (n < 0x7FFFFFFF));
                    },
                    required: false
                },
                contextStore: {value: ''},
                results: {
                    value: [
                        {
                            p: '',
                            pt: 'msgTopic',
                            v: '',
                            vt: 'topic'
                        },
                        {
                            p: '',
                            pt: 'msgPayload',
                            v: '',
                            vt: 'level'
                        },
                        {
                            p: 'slat',
                            pt: 'msg',
                            v: '',
                            vt: 'slat'
                        },
                        {
                            p: 'blindCtrl',
                            pt: 'msg',
                            v: '',
                            vt: 'ctrlObj'
                        }
                    ]
                },
                // #region blind settings
                blindIncrement: {
                    value: 0.01,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);

                        return (RED.validators.number()(v) &&
                                (n < mm.max) &&
                                (n > 0));
                    }
                },
                blindOpenPos: {
                    value: 1.00,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        return RED.validators.number()(v) &&
                                (Number.isInteger(n / parseFloat(getVal(this, 'blindIncrement')))) &&
                                (n !== parseFloat(getVal(this, 'blindClosedPos')));
                    }
                },
                blindClosedPos: {
                    value: 0.00,
                    required: true,
                    validate(v) {
                        const n = parseFloat(v);
                        return RED.validators.number()(v) &&
                                (Number.isInteger(n / parseFloat(getVal(this, 'blindIncrement')))) &&
                                (n !== parseFloat(getVal(this, 'blindOpenPos')));
                    }
                },
                blindPosReverse: {
                    value: false
                },
                blindPosDefault: {
                    value: 'open (max)',
                    validate: RED.validators.typedInput('blindPosDefaultType')
                },
                blindPosDefaultType: {
                    value: 'levelFixed'
                },
                slatPosDefault: {
                    value: '',
                    validate: RED.validators.typedInput('slatPosDefaultType')
                },
                slatPosDefaultType: {
                    value: 'none'
                },
                // #endregion blind settings
                // #region overwrite settings
                overwriteExpire: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        return (typeof v === 'undefined') ||
                               (v === '') ||
                               (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }
                },
                // #endregion overwrite settings
                // #region rule settings
                rules: {
                    value: {}
                },
                // #endregion rule settings
                // #region sun settings
                sunControlMode: {
                    value: '0',
                    required: true,
                    validate(v) {
                        const n = Number(v);
                        return (RED.validators.number()(v) &&
                                ((n === cNBC_MODE_OFF) || (n === cNBC_MODE_MINIMIZE) || (n === cNBC_MODE_MAXIMIZE) || (n === cNBC_MODE_SUN_CONTROL)));
                    }
                },
                sunFloorLengthType: {
                    value: 'num'
                },
                sunFloorLength: {
                    value: '',
                    required: false,
                    validate(v) {
                        const mode = Number(getVal(this, 'sunControlMode'));
                        return (mode === cNBC_MODE_OFF) ||
                                (mode === cNBC_MODE_MAXIMIZE) ||
                                (mode === cNBC_MODE_MINIMIZE) ||
                                RED.validators.typedInput('sunFloorLengthType')(v);
                    }
                },
                sunMinDelta: {
                    value: '',
                    required: false,
                    validate(v) {
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);
                        const mode = Number(getVal(this, 'sunControlMode'));
                        return (mode === cNBC_MODE_OFF) ||
                                (mode === cNBC_MODE_MAXIMIZE) ||
                                (mode === cNBC_MODE_MINIMIZE) ||
                                (v === '') ||
                                ((n <= mm.max) &&
                                (n >= mm.min) &&
                                (n >= parseFloat(getVal(this, 'blindIncrement'))) );
                    }
                },
                blindPosMin: {
                    value: 'closed (min)',
                    validate(v) {
                        return ((Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('blindPosMinType')(v));
                    }
                },
                blindPosMinType: {
                    value: 'levelFixed'
                },
                blindPosMax: {
                    value: 'open (max)',
                    validate(v) {
                        return ((Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('blindPosMaxType')(v));
                    }
                },
                blindPosMaxType: {
                    value: 'levelFixed'
                },
                blindOpenPosOffset: {
                    value: 0.00,
                    required: false,
                    validate(v) {
                        if (typeof v === 'undefined' || v === '') return true;
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);
                        return n === 0.00 ||
                            (RED.validators.number()(v) &&
                            (Number.isInteger(n / parseFloat(getVal(this, 'blindIncrement')))) &&
                            (n < mm.max) &&
                            (n > mm.min));
                    }
                },
                blindClosedPosOffset: {
                    value: 0.00,
                    required: false,
                    validate(v) {
                        if (typeof v === 'undefined' || v === '') return true;
                        const n = parseFloat(v);
                        const mm = getMinMaxBlindPos(this);
                        return n === 0.00 ||
                            (RED.validators.number()(v) &&
                            (Number.isInteger(n / parseFloat(getVal(this, 'blindIncrement')))) &&
                            (n < mm.max) &&
                            (n > mm.min));
                    }
                },
                sunSlat: {
                    value: '',
                    validate: RED.validators.typedInput('sunSlatType')
                },
                sunSlatType: {
                    value: 'none'
                },
                smoothTime: {
                    value: '',
                    validate(v) {
                        const n = parseFloat(v);
                        return ((Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                (v === '') ||
                                (RED.validators.number()(v) && (n > -2147483647) && (n < 0x7FFFFFFF)));
                    }
                },
                sunTopic: {
                    value: '',
                    required: false
                },
                // #endregion sun settings
                // #region window settings
                windowTopType: {
                    value: 'num'
                },
                windowTop: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('blindPosMaxType')(v);
                    }
                },
                windowBottomType: {
                    value: 'num'
                },
                windowBottom: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('blindPosMaxType')(v);
                    }
                },
                windowAzimuthStartType: {
                    value: 'numAzimuth'
                },
                windowAzimuthStart: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('windowAzimuthStartType')(v);
                    }
                },
                windowAzimuthEndType: {
                    value: 'numAzimuth'
                },
                windowAzimuthEnd: {
                    value: '',
                    validate(v) {
                        return (Number(getVal(this, 'sunControlMode')) === cNBC_MODE_OFF) ||
                                RED.validators.typedInput('windowAzimuthEndType')(v);
                    }
                },
                // #endregion window settings
                // #region oversteering settings
                oversteers: {
                    value: {}
                },
                oversteerTopic: {
                    value: '',
                    required: false
                },
                oversteerValue          : { value: ''},
                oversteerValueType      : { value: ''},
                oversteerCompare        : { value: ''},
                oversteerThreshold      : { value: ''},
                oversteerThresholdType  : { value: ''},
                oversteerBlindPos       : { value: ''},
                oversteerBlindPosType   : { value: ''},
                oversteer2Value         : { value: ''},
                oversteer2ValueType     : { value: ''},
                oversteer2Compare       : { value: ''},
                oversteer2Threshold     : { value: ''},
                oversteer2ThresholdType : { value: ''},
                oversteer2BlindPos      : { value: ''},
                oversteer2BlindPosType  : { value: ''},
                oversteer3Value         : { value: ''},
                oversteer3ValueType     : { value: ''},
                oversteer3Compare       : { value: ''},
                oversteer3Threshold     : { value: ''},
                oversteer3ThresholdType : { value: ''},
                oversteer3BlindPos      : { value: ''},
                oversteer3BlindPosType  : { value: ''},
                sunMinAltitude          : { value: ''}
                // #endregion oversteering settings
            },
            outputLabels(index) {
                if (index > 0) {
                    return this._('blind-control.label.output' + (index + 1));
                }
                const types = {
                    msgPayload : 'msg.payload',
                    msgTopic   : 'msg.topic',
                    msgValue   : 'msg.value'
                };
                const labels = {
                    level: 'blind position',
                    slat: 'slat position',
                    topic: 'topic',
                    ctrlObj: 'status object',
                    str: 'string',
                    num: 'number',
                    bool: 'boolean',
                    flow: 'flow context',
                    global: 'global context',
                    bin: 'binary data',
                    date: 'timestamp',
                    dateSpecific: 'special timestamp',
                    entered: 'timestamp',
                    dateEntered: 'timestamp',
                    env: 'Environment variable',
                    jsonata: 'result of jsonata expression',
                    nodeId: 'additional node ID',
                    nodeName: this.name,
                    nodePath: this._path || this.name
                };

                // if only payload and topic - display payload type
                // if only one property - show it's type
                // if more than one property (other than payload and topic) - show "x properties" where x is the number of properties.
                // this.results will not be an array for legacy inject nodes until they are re-deployed
                //
                let results = this.results;
                if (!results || !Array.isArray(results)) {
                    results = [
                        {
                            p: '',
                            pt: 'msgTopic',
                            v: '',
                            vt: 'topic'
                        },
                        {
                            p: '',
                            pt: 'msgPayload',
                            v: '',
                            vt: 'level'
                        },
                        {
                            p: 'slat',
                            pt: 'msg',
                            v: '',
                            vt: 'slat'
                        },
                        {
                            p: 'blindCtrl',
                            pt: 'msg',
                            v: '',
                            vt: 'ctrlObj'
                        }];
                }
                let lab = '';
                if (results) {
                    let cnt = -1;
                    for (let i=0, l=results.length; i<l; i++) {
                        if (!results[i].pt.includes('msg')) { continue; }
                        cnt++;
                        if (cnt > 0) lab += '\n';
                        if (cnt === 5) {
                            lab += ' + ' + (results.length - 4);
                            break;
                        }
                        lab += (types[results[i].pt] ? types[results[i].pt] : (results[i].pt + '.' + results[i].p)) + ': ';
                        let propType = labels[results[i].vt] ? labels[results[i].vt] : results[i].vt;
                        if (propType === 'json' || propType === 'object') {
                            try {
                                const parsedProp = JSON.parse(results[i].v);
                                propType = typeof parsedProp;
                                if (propType === 'object' && Array.isArray(parsedProp)) {
                                    propType = 'Array';
                                }
                            } catch (ex) {
                                propType = 'invalid';
                            }
                        }
                        lab += propType;
                    }
                }
                return lab || '?';
            },
            label() {
                if (this.name) {
                    return this.name;
                }
                const result = this._('blind-control.label.blind-control');
                if (this.topic && (this.topic.length + result.length <= 32)) {
                    return this.topic + ':' + result;
                }
                return result;
            },
            labelStyle() {
                return this.name ? 'node_label_italic' : '';
            },
            paletteLabel() { return this._('blind-control.label.blind-control-palette'); },
            oneditprepare() {
                /** resizes a rule container */
                function resizeRuleContainer() {
                    try {
                        const editorRow = $('.node-input-rule-container-row ol');
                        const height = editorRow.outerHeight(true);
                        const rowCount = $('#node-input-rule-container').editableList('length');
                        if (rowCount > 0) {
                            // $('#node-input-rule-container').editableList('height', height + 40);
                            $('#node-input-rule-container').css('min-height', height + 'px');
                        } else {
                            // $('#node-input-rule-container').editableList('height', 40);
                            $('#node-input-rule-container').css('min-height', '40px');
                        }
                    } catch (ex) {
                        console.log(ex); // eslint-disable-line
                    }
                }

                /** resizes the rule container */
                function resizeRuleContainerCheck(node) {
                    if (node.dialogAddData.resizeRuleContainerTO) { clearTimeout(node.dialogAddData.resizeRuleContainerTO); }
                    node.dialogAddData.resizeRuleContainerTO = setTimeout(() => {
                        delete node.dialogAddData.resizeRuleContainerTO;
                        $('#node-input-sunControlMode').change();
                        resizeRuleContainer();
                    }, 600);
                }

                setTimeout(() => {
                    $('.is-to-show-initially').show();
                    $('.is-to-hide-initially').hide();
                }, 300);
                $('.rdg-ui-btn').button();

                const $nodeConfig = $('#node-input-positionConfig');
                const node = this;

                const $nodeInputContextStore = $('#node-input-contextStore');
                RED.settings.context.stores.forEach(store => {
                    $nodeInputContextStore.append('<option value="' + store + '"' + (this.contextStore === store ? ' selected' : '') + '>' + store + '</option>');
                });

                const tabs = RED.tabs.create({
                    id: 'node-config-blind-control-tabs',
                    onchange(tab) {
                        $('#node-config-blind-control-tabs-content').children().hide();
                        $('#' + tab.id).show();
                        resizeRuleContainerCheck(node);
                    },
                    scrollable: true,
                    collapsible: true
                });

                this.sunControlMode = this.sunControlMode || cNBC_MODE_OFF;
                if (this.sunControlMode === 2 || this.sunControlMode === '2') {
                    this.sunControlMode = cNBC_MODE_SUN_CONTROL;
                    $('#node-input-sunControlMode').val(cNBC_MODE_SUN_CONTROL);
                }

                node.dialogAddData = {};
                const setup = function(node) {
                    /* global getTypes getSelectFields setupTInput appendOptions addLabel getBackendData bdDateToTime initCheckboxesBlock getCheckboxesStr setTInputValue */
                    // #region initialize
                    const types = getTypes(node);
                    types.LevelEntered = {
                        value: 'num',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelfree'),
                        icon: 'red/images/typedInput/09.svg',
                        validate(v) {
                            if (!RED.validators.number()(v) || (v === '')) {
                                return false;
                            }
                            const inc = parseFloat(getVal(this, 'blindIncrement'));
                            if (isNaN(inc)) {
                                return true;
                            }
                            const mm = getMinMaxBlindPos(this);
                            const n = parseFloat(v);
                            if (isNaN(n) || (n > mm.max) || (n < mm.min)) {
                                return false;
                            }
                            return Number.isInteger(Number((n / inc).toFixed((inc === inc>> 0 ? 0 : inc.toString().split('.')[1].length || 0) + 2)));
                        }
                    };
                    types.LevelFix = {
                        value: 'levelFixed',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelfix'),
                        icon: 'icons/node-red-contrib-sun-position/inputTypeLevel.svg',
                        options: [{
                            value: 'open (max)',
                            label: node._('blind-control.typeOptions.100')
                        }, {
                            value: '75%',
                            label: node._('blind-control.typeOptions.75')
                        }, {
                            value: '66%',
                            label: node._('blind-control.typeOptions.66')
                        }, {
                            value: '50%',
                            label: node._('blind-control.typeOptions.50')
                        }, {
                            value: '33%',
                            label: node._('blind-control.typeOptions.33')
                        }, {
                            value: '25%',
                            label: node._('blind-control.typeOptions.25')
                        }, {
                            value: '10%',
                            label: node._('blind-control.typeOptions.10')
                        }, {
                            value: 'closed (min)',
                            label: node._('blind-control.typeOptions.0')
                        }]
                    };
                    types.LevelND= {
                        value: 'levelND',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelND'),
                        icon: 'icons/node-red-contrib-sun-position/inputTypeNone2.svg',
                        hasValue: false
                    };
                    types.SunControlModeType = {
                        value: 'sunControlMode',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.sunControlMode','moon phase'),
                        icon: 'icons/node-red-contrib-sun-position/inputTypeSunControl.svg',
                        options: [{
                            value: cNBC_MODE_OFF + '-off',
                            label: node._('node-red-contrib-sun-position/position-config:common.types.sunControlOff')
                        }, {
                            value: cNBC_MODE_MAXIMIZE + '-maximize',
                            label: node._('node-red-contrib-sun-position/position-config:common.types.sunControlMaximize')
                        }, {
                            value: cNBC_MODE_MINIMIZE + '-minimize',
                            label: node._('node-red-contrib-sun-position/position-config:common.types.sunControlMinimize')
                        }, {
                            value: cNBC_MODE_SUN_CONTROL + '-restrict',
                            label: node._('node-red-contrib-sun-position/position-config:common.types.sunControlRestrict')
                        }]
                    };
                    types.OutputLevel = {
                        value: 'level',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.level'),
                        hasValue: false
                    };
                    types.OutputLevelInverse = {
                        value: 'levelInverse',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.levelInverse'),
                        hasValue: false
                    };
                    types.OutputSlat = {
                        value: 'slat',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.slat'),
                        hasValue: false
                    };
                    types.OutputTopic = {
                        value: 'topic',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.topic'),
                        hasValue: false
                    };
                    types.OutputCtrlObj = {
                        value: 'ctrlObj',
                        label: node._('node-red-contrib-sun-position/position-config:common.types.ctrlObj'),
                        hasValue: false
                    };
                    const selFields = getSelectFields();
                    /**
                     * save rules
                     * @param {*} node - the node representation
                     * @param {string} name - the node representation
                     * @param {*} element - the node representation
                     * @param {function} validate - ovalidation function of the input
                     * @param {number} defMultiplier - default multiplier (in ms)
                     * @param {number} minMultiplier - minimum multiplier (in ms)
                    */
                    function setMultiplier(node, name, element, validate, defMultiplier, minMultiplier) {
                        const c = Number(node[name]);
                        if (node[name] !== '' && !isNaN(c) && c !== 0) {
                            let r = minMultiplier || 1000;
                            if (c % 86400000 === 0) {
                                r = 86400000; // Days
                            } else if (c % 3600000 === 0) {
                                r = 3600000; // Hours
                            } else if (c % 60000 === 0) {
                                r = 60000; // Minutes
                            }
                            $('#blind-control-' + name).val(c/r);
                            $('#blind-control-' + name + '-multiplier').val(r);
                        } else {
                            $('#blind-control-' + name).val('');
                            $('#blind-control-' + name + '-multiplier').val(defMultiplier || 1000);
                        }
                        $('#blind-control-' + name).on('change focus focusout', () => {
                            const el = $('#blind-control-' + name);
                            let val = el.val();
                            const mp = $('#blind-control-' + name + '-multiplier').val();
                            if (isNaN(val) || val === '' || val === 0) {
                                val = '';
                                $('node-input-' + name).val('');
                            } else {
                                val = val * mp;
                                $('#node-input-' + name).val(val);
                            }

                            if (typeof validate === 'function') {
                                if (validate(val)) {
                                    el.removeClass( 'input-error' );
                                } else {
                                    el.addClass( 'input-error' );
                                }
                            }
                        });

                        $('#blind-control-' + name + '-multiplier').change( () => {
                            $('#blind-control-' + name).change();
                        });
                        $('#blind-control-' + name).change();
                    }
                    /**
                     * get the default level
                     * @param {string} type - the type value
                     * @param {string} value - value
                     * @param {string} def - the default value
                     * @returns {string} the default value for the level
                    */
                    function getDefLevel(type, value, def) {
                        if (value) {
                            return value;
                        }
                        if (!type || type === types.LevelFix.value) {
                            return def;
                        }
                        return def;
                    }
                    // #endregion initialize
                    // #region blind
                    setMultiplier(node,'overwriteExpire', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number()(v) && (n >= 200) && (n < 0x7FFFFFFF));
                    }, 3600000, 1000);
                    setMultiplier(node,'autoTriggerTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 60000) && (n < 0x7FFFFFFF));
                    }, 3600000, 60000);
                    setMultiplier(node,'startDelayTime', v => {
                        const n = parseFloat(v);
                        return (RED.validators.number()(v) && (n >= 0) && (n < 0x7FFFFFFF));
                    }, 600000, 0);

                    setupTInput(node, {
                        typeProp: 'blindPosDefaultType',
                        valueProp: 'blindPosDefault',
                        width: 'calc(100% - 110px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosDefaultType, node.blindPosDefault, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'slatPosDefaultType',
                        valueProp: 'slatPosDefault',
                        width: 'calc(100% - 110px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [
                            types.Undefined,
                            'str',
                            'num',
                            'bool',
                            types.MsgPayload,
                            types.MsgValue,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.randomNumber,
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    });

                    setupTInput(node, {
                        typeProp: 'sunFloorLengthType',
                        valueProp: 'sunFloorLength',
                        width: 'calc(100% - 110px)',
                        defaultType: 'num',
                        defaultValue: '0',
                        types: ['num', 'msg', 'flow', 'global', 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'windowTopType',
                        valueProp: 'windowTop',
                        width: 'calc(100% - 110px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', types.MsgValue, types.MsgPayloadByTopic, 'msg', 'flow', 'global', 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'windowBottomType',
                        valueProp: 'windowBottom',
                        width: 'calc(100% - 110px)',
                        defaultType: 'num',
                        defaultValue: '',
                        types: ['num', types.MsgValue, types.MsgPayloadByTopic, 'msg', 'flow', 'global', 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'windowAzimuthStartType',
                        valueProp: 'windowAzimuthStart',
                        width: 'calc(100% - 110px)',
                        defaultType: types.numAzimuth.value,
                        defaultValue: '',
                        types: [types.numAzimuth, types.MsgValue, types.MsgPayloadByTopic, 'msg', 'flow', 'global', 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'windowAzimuthEndType',
                        valueProp: 'windowAzimuthEnd',
                        width: 'calc(100% - 110px)',
                        defaultType: types.numAzimuth.value,
                        defaultValue: '',
                        types: [types.numAzimuth, types.MsgValue, types.MsgPayloadByTopic, 'msg', 'flow', 'global', 'env']
                    });

                    setupTInput(node, {
                        typeProp: 'addIdType',
                        valueProp: 'addId',
                        width: 'calc(100% - 110px)',
                        defaultType: node.addIdType || (node.addId ? 'str' : types.Undefined.value),
                        defaultValue: '',
                        types: [types.Undefined, 'str', 'flow', 'global', 'env'] // types.MsgPayload, types.MsgTopic, types.MsgPayloadByTopic, types.MsgValue, 'msg',
                    });
                    // #endregion blind
                    // #region rules
                    const ruleVersion = 3;
                    /**
                     * get a time in millisecond as string of the format hh:mm, hh:mm:ss or hh:mm:ss.mss
                     * @param {number} s - milisecond
                     * @returns {string} time as string
                     */
                    function msToTime(s) {
                        // Pad to 2 or 3 digits, default is 2
                        const pad = (n, z = 2) => ('00' + n).slice(-z);
                        const sec = (s%6e4)/1000|0;
                        const msec = s%1000;
                        return pad(s/3.6e6|0) + ':' + pad((s%3.6e6)/6e4 | 0) + ((msec >0) ? (':' + pad(sec) +'.' + pad(msec, 3) ) : ((sec>0) ? ':' + pad(sec) : ''));
                    }

                    /**
                     * get the time offset text
                     */
                    function _getOffsetText(node, t,v,m) {
                        let result = '';
                        if (t && t !== 'none') {
                            if (t === 'num') {
                                const osmillis = v * m;
                                if (osmillis>0) {
                                    result += ' + ' + msToTime(osmillis);
                                } else {
                                    result += ' - ' +msToTime(osmillis * -1);
                                }
                            } else {
                                result += ' offset <var>' + RED.nodes.getType('position-config').getValueLabel(node, t, v) + '</var>';
                                // result += ' * ' + data.multiplier/1000 + 's';
                            }
                        }
                        return result;
                    }
                    /**
                     * get a formated date limit
                    */
                    function getDateShort(value) {
                        if (value) {
                            const val = value.split('-');
                            if (val.length > 2) {
                                return val[1] + '-' + val[2];
                            } else if (val.length === 2) {
                                return val[0] + '-' + val[1];
                            }
                        }
                        return '';
                    }
                    /**
                     * sets a property of an object
                     * @param {object} obj - object to set property
                     * @param {string|array} arr - property of object to set 'sub1.sub2.propA' or ['sub1', 'sub2', 'propA']
                     * @param {*} val - value to set
                     * @returns {object} description of the rule
                     */
                    function addProps(obj, arr, val) {
                        if (typeof arr === 'string')
                            arr = arr.split('.');
                        obj[arr[0]] = obj[arr[0]] || {};
                        const tmpObj = obj[arr[0]];
                        if (arr.length > 1) {
                            arr.shift();
                            addProps(tmpObj, arr, val); // eslint-disable-line no-unused-vars
                        } else {
                            obj[arr[0]] = val;
                        }
                        return obj;
                    }
                    /**
                     * get number of operand for a comparision opeator
                     * @param {object} selFields - fields object
                     * @param {string} operator - value of comperator selection
                     * @returns {number} description of the rule
                     */
                    function getOperandCount(selFields, operator) {
                        operator = operator || selFields.comparator[0].id;
                        const fields = selFields.comparator;
                        const fieldsLength = fields.length;
                        for (let index = 0; index < fieldsLength; index++) {
                            const el = fields[index];
                            if (el.id === operator) {
                                return el.operandCount;
                            }
                        }
                        return 1;
                    }
                    /**
                     * get a description of the rule rules
                     * @param {object} data - a rule description
                     * @returns {string} description of the rule
                     */
                    function getRuleDescription(node, selFields, data, enh) {
                        let result = '';
                        const length = (enh) ? 60 : 30;
                        try {
                            if (typeof data.isValid === 'undefined' || typeof data.version === 'undefined' || (!data.isValid && (typeof data.valid === 'undefined' || Object.keys(data.valid).length === 0))) {
                                result += '<div>';
                                result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.outDated');
                                result += '</div>';
                            } else if (!data.isValid) {
                                result += '<div>';
                                result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.isInValid');
                                result += '</div>';
                                if (data.valid && Object.keys(data.valid).length > 0) {
                                    result += '<div><pre>';
                                    result += JSON.stringify(data.valid, null, '\t');
                                    result += '</pre></div>';
                                }
                            }
                            if (data.conditions && data.conditions.length > 0) {
                                result += '<div>';
                                result += '<i class="fa fa-code-fork" aria-hidden="true"></i> ';
                                const l = data.conditions.length-1;
                                const addBrac = l > 1;

                                for (let i = 0; i <= l; i++) {
                                    const cond = data.conditions[i];
                                    if (i > 0) {
                                        result += '&nbsp;<strong>' + cond.conditionText + '</strong><br/><span class="indent-enh-text" >&nbsp;</span>';
                                    }
                                    if (addBrac && i > 0 && i < l) {
                                        result += '(&nbsp;';
                                    }
                                    if (cond.valueType === 'sunControlMode') {
                                        result += 'Mode is <var>' + cond.value + '</var>';
                                    } else if (cond.valueType === 'pdmPhaseCheck') {
                                        result += 'Moon phase is <var>' + cond.value + '</var>';
                                    } else {
                                        result += '<var>' + RED.nodes.getType('position-config').getValueLabel(node, cond.valueType, cond.value, null, length) + '</var>';
                                        result += ' ' + cond.operatorText;
                                        const oc = getOperandCount(selFields, cond.operator);
                                        if (oc > 1) {
                                            const ttext = RED.nodes.getType('position-config').getValueLabel(node, cond.thresholdType, cond.threshold, null, length);
                                            result += ' ';
                                            result += ttext;
                                            if (enh && enh.cond && enh.cond[i] && enh.cond[i].operand) {
                                                result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.cond[i].operand + '</code>';
                                                result += ' ' + cond.operatorText + '&nbsp;<code>';
                                                if(enh.cond[i].threshold) {
                                                    result += enh.cond[i].threshold;
                                                } else {
                                                    result += ttext;
                                                }
                                                result += '</code>]</span>';
                                            }
                                        } else if (enh && enh.cond && enh.cond[i] && enh.cond[i].operand) {
                                            result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;is&nbsp;<code>' + enh.cond[i].operand + '</code>]</span>';
                                        }
                                    }
                                }
                                if (addBrac) {
                                    result += '&nbsp;';
                                    result += Array(l).join(')');
                                }
                                result += '</div>';
                            }
                            if (data.time) {
                                if (data.time.type && data.timeType !== 'none') {
                                    result += '<div>';
                                    result += '<i class="fa fa-clock-o" aria-hidden="true"></i> ';
                                    result += data.time.operatorText;
                                    result += ' <var>' + RED.nodes.getType('position-config').getValueLabel(node, data.time.type, data.time.value, null, length) + '</var>';
                                    result += _getOffsetText(node, data.time.offsetType, data.time.offset, data.time.multiplier);
                                    if (enh && enh.timeReg && enh.timeReg.text) {
                                        result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.timeReg.text + '</code>]</span>';
                                    }

                                    if (data.timeMin && data.timeMin.type && data.timeMin.type !== 'none') {
                                        result += '<div class="indent-time-text"><i class="fa fa-step-backward" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMin');
                                        result += '</span> <var>';
                                        result += RED.nodes.getType('position-config').getValueLabel(node, data.timeMin.type, data.timeMin.value, null, length);
                                        result += '</var>';
                                        result += _getOffsetText(node, data.timeMin.offsetType, data.timeMin.offset, data.timeMin.multiplier);
                                        if (enh && enh.timeMin && enh.timeMin.text) {
                                            result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.timeMin.text + '</code>]</span>';
                                        }
                                        result += '</div>';
                                    }
                                    if (data.timeMax && data.timeMax.type && data.timeMax.type !== 'none') {
                                        result += '<div class="indent-time-text"><i class="fa fa-step-forward" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMax');
                                        result += '</span> <var>';
                                        result += RED.nodes.getType('position-config').getValueLabel(node, data.timeMax.type, data.timeMax.value, null, length);
                                        result += '</var>';
                                        result += _getOffsetText(node, data.timeMax.offsetType, data.timeMax.offset, data.timeMax.multiplier);
                                        if (enh && enh.timeMax && enh.timeMax.text) {
                                            result += ' <span class="indent-enh-text">[<i class="fa fa-hand-o-right" aria-hidden="true"></i>&nbsp;<code>' + enh.timeMax.text + '</code>]</span>';
                                        }
                                        result += '</div>';
                                    }
                                    if (data.time.days && data.time.days !== '*') {
                                        result += '<div class="indent-time-days"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeDays');
                                        result += '</span> <var>';
                                        const daysarr = data.time.days.split(',');
                                        if (daysarr.length === 1) {
                                            result += (node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7)));
                                        } else if (data.time.days === '5,6,0') {
                                            result += node._('node-red-contrib-sun-position/position-config:common.days.12');
                                            result += '-';
                                            result += node._('node-red-contrib-sun-position/position-config:common.days.7');
                                        } else if (daysarr.length === 2) {
                                            result += node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[0]) + 7));
                                            result += ' ';
                                            result += node._('node-red-contrib-sun-position/position-config:common.label.and');
                                            result += ' ';
                                            result += node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(daysarr[1]) + 7));
                                        } else {
                                            daysarr.sort((a, b) => parseInt(a) - parseInt(b));
                                            let isok = true;
                                            let elF = parseInt(daysarr[0]);
                                            daysarr[0] = node._('node-red-contrib-sun-position/position-config:common.days.'+(elF + 7));
                                            for (let index = 1; index < daysarr.length; index++) {
                                                const element = parseInt(daysarr[index]);
                                                isok = isok && (element === elF+1);
                                                elF = element;
                                                daysarr[index] = node._('node-red-contrib-sun-position/position-config:common.days.'+(parseInt(element) + 7));
                                            }
                                            if (isok) {
                                                result += (daysarr[0] + '-' + daysarr[daysarr.length-1]);
                                            } else {
                                                result += (daysarr.join(','));
                                            }
                                        }
                                        result += '</var></div>';
                                    }
                                    if (data.time.onlyEvenDays || data.time.onlyOddDays || data.time.onlyEvenWeeks || data.time.onlyOddWeeks) {
                                        result += '<div class="indent-time-special"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimit');
                                        result += '</span> <var>';
                                        const resultArr = [];
                                        if (data.time.onlyEvenDays) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenDays'));
                                        }
                                        if (data.time.onlyOddDays) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddDays'));
                                        }
                                        if (data.time.onlyEvenWeeks) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks'));
                                        }
                                        if (data.time.onlyOddWeeks) {
                                            resultArr.push(node._('node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks'));
                                        }
                                        result += resultArr.join(' <b>' + node._('node-red-contrib-sun-position/position-config:common.label.and') + '</b> ');
                                        result += '</var></div>';
                                    }
                                    if (data.time.months && data.time.months !== '*') {
                                        result += '<div class="indent-time-months"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMonths');
                                        result += '</span> <var>';
                                        const montharr = data.time.months.split(',');
                                        if (montharr.length === 2) {
                                            result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                            result += ' ';
                                            result += node._('node-red-contrib-sun-position/position-config:common.label.and');
                                            result += ' ';
                                            result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[1]) + 12));
                                        } else if (montharr.length === 1) {
                                            result += node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(montharr[0]) + 12));
                                        } else {
                                            montharr.sort((a, b) => parseInt(a) - parseInt(b));
                                            let isok = true;
                                            let elF = parseInt(montharr[0]);
                                            montharr[0] = node._('node-red-contrib-sun-position/position-config:common.months.'+(elF + 12));
                                            for (let index = 1; index < montharr.length; index++) {
                                                const element = parseInt(montharr[index]);
                                                isok = isok && (element === elF+1);
                                                elF = element;
                                                montharr[index] = node._('node-red-contrib-sun-position/position-config:common.months.'+(parseInt(element) + 12));
                                            }
                                            if (isok) {
                                                result += montharr[0];
                                                result += '-';
                                                result += montharr[montharr.length-1];
                                            } else {
                                                result += montharr.join(',');
                                            }
                                        }
                                        result += '</var></div>';
                                    }

                                    if (data.time.dateStart || data.time.dateEnd) {
                                        result += '<div class="indent-time-datelimit"><i class="fa fa-calendar-o" aria-hidden="true"></i> <span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimitStart');
                                        result += '</span> <var>';
                                        if (enh) {
                                            const year = (new Date()).getFullYear();
                                            result += data.time.dateStart || year + '-01-01';
                                        } else {
                                            result += (getDateShort(data.time.dateStart) || '01-01');
                                        }
                                        result += '</var> <span> ';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeLimitEnd');
                                        result += '</span> <var>';
                                        if (enh) {
                                            const year = (new Date()).getFullYear();
                                            result += data.time.dateEnd || year + '-12-31';
                                        } else {
                                            result += (getDateShort(data.time.dateEnd) || '12-31');
                                        }
                                        result += '</var></div>';
                                    }
                                    result += '</div>';
                                }
                            }
                            result += '<div>';
                            if (data.level) {
                                if (data.level.operator <= cNBC_RULE_OP.levelAbsolute || data.levelType === types.LevelND.value) {
                                    if (typeof data.level.type !== 'undefined' && data.level.type !== types.LevelND.value) {
                                        result += '<div class="indent-level-text"> <i class="fa fa-angle-down" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleBlindLevel');
                                        result += ': </span> ';
                                        result += data.level.operatorText;
                                        result += ' <var>';
                                        result += RED.nodes.getType('position-config').getValueLabel(node, data.level.type, data.level.value, null, length);
                                        result += '</var></div>';
                                    } else {
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelND');
                                    }
                                    if (data.slat.type !== 'none') {
                                        result += '<div class="indent-slatPos-text"> <i class="fa fa-slack" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleSlat');
                                        result += ': </span> <var>';
                                        result += RED.nodes.getType('position-config').getValueLabel(node, data.slat.type, data.slat.value, null, length);
                                        result += '</var>';
                                    }
                                    if (data.topic) {
                                        result += '<div class="indent-topic-text"> <i class="fa fa-tasks" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTopic');
                                        result += ': </span> <var>';
                                        result += data.topic;
                                        result += '</var>';
                                        result += '</div>';
                                    }
                                    if (data.resetOverwrite) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-thumbs-o-down" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleResetOverwrite');
                                        result += '</span> </div>';
                                    }
                                    if (data.importance > 0) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-hand-spock-o" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance');
                                        result += ' = </span><var>';
                                        result += data.importance;
                                        result += '</var></div>';
                                    }
                                } else if (data.level.operator === cNBC_RULE_OP.levelMinOversteer) {
                                    result += '<div class="indent-level-text"> <i class="fa fa-chevron-circle-down" aria-hidden="true"></i><span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleBlindLevelMinimum');
                                    result += ': </span><var>';
                                    result += RED.nodes.getType('position-config').getValueLabel(node, data.level.type, data.level.value, null, length);
                                    result += '</var></div>';
                                } else if (data.level.operator === cNBC_RULE_OP.levelMaxOversteer) {
                                    result += '<div class="indent-level-text"> <i class="fa fa-chevron-circle-up" aria-hidden="true"></i><span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleBlindLevelMaximum');
                                    result += ': </span><var>';
                                    result += RED.nodes.getType('position-config').getValueLabel(node, data.level.type, data.level.value, null, length);
                                    result += '</var></div>';
                                } else if (data.level.operator === cNBC_RULE_OP.slatOversteer) {
                                    result += '<div class="indent-slatPos-text"> <i class="fa fa-slack" aria-hidden="true"></i><span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleSlatOversteer');
                                    result += ': </span><var>';
                                    result += RED.nodes.getType('position-config').getValueLabel(node, data.slat.type, data.slat.value, null, length);
                                    result += '</var>';
                                    if (data.importance > 0) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-hand-spock-o" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance');
                                        result += ' = </span><var>';
                                        result += data.importance;
                                        result += '</var></div>';
                                    }
                                } else if (data.level.operator === cNBC_RULE_OP.topicOversteer) {
                                    result += '<div class="indent-topic-text"> <i class="fa fa-tasks" aria-hidden="true"></i><span>';
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTopicOversteer');
                                    result += ': </span><var>';
                                    result += (data.topic || '""');
                                    result += '</var>';
                                    result += '</div>';
                                    if (data.importance > 0) {
                                        result += '<div class="indent-resetOverwrite-text"> <i class="fa fa-hand-spock-o" aria-hidden="true"></i><span>';
                                        result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance');
                                        result += ' = </span><var>';
                                        result += data.importance;
                                        result += '</var></div>';
                                    }
                                } else if (data.level.operator === cNBC_RULE_OP.off) {
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleOff');
                                } else {
                                    result += node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelND');
                                }
                            }
                            result += '</div>';
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            result = 'Error: "' + err.message + '"';
                        }
                        return result;
                    }

                    $('#node-input-rule-container').css('min-height', '40px').css('min-width', '300px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            if (data === {}) {
                                data.description = 'please edit rule';
                                data.name = 'empty';
                                data.version = ruleVersion;
                                data.enabled = true;
                            }
                            data.index = containerIndex;
                            data.importance = 0;
                            if (!data.conditions) {
                                data.valid = {};
                                data.conditions = [];
                                if (data.validOperandAType && data.validOperandAType !== types.Unlimited.value) {
                                    data.conditions.push({
                                        condition       : 1,        // condition
                                        conditionText   : '',
                                        valueType       : data.validOperandAType,
                                        value           : data.validOperandAValue,
                                        operator        : data.validOperator || selFields.comparator[0].id,
                                        operatorText    : data.validOperatorText,
                                        thresholdType   : (data.validOperandBType || 'num'),
                                        threshold       : data.validOperandBValue
                                    });
                                    if ((parseInt(data.valid2LogOperator) > 0) && data.valid2OperandAType) {
                                        data.conditions.push({
                                            condition       : (parseInt(data.valid2LogOperator) || 1), // condition
                                            conditionText   : data.valid2LogOperatorText,
                                            valueType       : (data.valid2OperandAType || 'msg'),
                                            value           : data.valid2OperandAValue,
                                            operator        : data.valid2Operator || selFields.comparator[0].id,
                                            operatorText    : data.valid2OperatorText,
                                            thresholdType   : (data.valid2OperandBType || 'num'),
                                            threshold       : data.valid2OperandBValue
                                        });
                                    }
                                }
                                delete data.validOperandAValue;
                                delete data.validOperandAType;
                                delete data.validOperator;
                                delete data.validOperatorText;
                                delete data.validOperandBValue;
                                delete data.validOperandBType;
                                delete data.valid2LogOperator;
                                delete data.valid2LogOperatorText;
                                delete data.valid2OperandAValue;
                                delete data.valid2OperandAType;
                                delete data.valid2Operator;
                                delete data.valid2OperatorText;
                                delete data.valid2OperandBValue;
                                delete data.valid2OperandBType;
                            }
                            if(data.timeBType) {
                                if (data.timeBType === types.TimeSun.value || data.timeBType === types.TimeMoon.value) {
                                    data.timeMinType = data.timeType;
                                    data.timeMinValue = data.timeValue;
                                    data.timeType = data.timeBType;
                                    data.timeValue = data.timeBValue;
                                } else {
                                    data.timeMinType = data.timeBType;
                                    data.timeMinValue = data.timeBValue;
                                }
                                delete data.timeBType;
                                delete data.timeBValue;
                                delete data.timeBOp;
                                delete data.timeBOpText;
                                data.isValid = false;
                                data.description = node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleIsOutdated');
                            }
                            if(data.timeType) {
                                if (!data.time && data.timeType !== types.Undefined.value) {
                                    data.time = {
                                        type            : data.timeType,
                                        value           : (data.timeValue || ''),
                                        operator        : (parseInt(data.timeOp) || 0),
                                        offsetType      : (data.offsetType || types.Undefined.value),
                                        offset          : (data.offsetValue || '1'),
                                        multiplier      : (parseInt(data.multiplier) || 60000),
                                        days            : (data.timeDays || '*'),
                                        months          : (data.timeMonths || '*')
                                    };
                                    if (data.timeOnlyOddDays) data.time.onlyOddDays = data.timeOnlyOddDays;
                                    if (data.timeOnlyEvenDays) data.time.onlyEvenDays = data.timeOnlyEvenDays;
                                    if (data.timeDateStart) data.time.dateStart = data.timeDateStart;
                                    if (data.timeDateEnd) data.time.dateEnd = data.timeDateEnd;
                                    if (data.timeOpText) data.time.operatorText = data.timeOpText;
                                }
                                delete data.timeType;
                                delete data.timeValue;
                                delete data.timeOp;
                                delete data.timeOpText;
                                delete data.offsetType;
                                delete data.offsetValue;
                                delete data.multiplier;
                                delete data.timeDays;
                                delete data.timeMonths;
                                delete data.timeOnlyOddDays;
                                delete data.timeOnlyEvenDays;
                                delete data.timeDateStart;
                                delete data.timeDateEnd;
                                if (data.time && data.time.onlyEvenDays && data.time.onlyOddDays) {
                                    delete data.time.onlyEvenDays;
                                    delete data.time.onlyOddDays;
                                }
                            }
                            if (data.timeMinType) {
                                if (!data.timeMin && data.timeMinType !== types.Undefined.value) {
                                    data.timeMin = {
                                        type            : data.timeMinType,
                                        value           : (data.timeMinValue || ''),
                                        offsetType      : (data.offsetMinType || types.Undefined.value),
                                        offset          : (data.offsetMinValue || '1'),
                                        multiplier      : (parseInt(data.multiplierMin) || 60000)
                                    };
                                }
                                delete data.timeMinType;
                                delete data.timeMinValue;
                                delete data.offsetMinType;
                                delete data.offsetMinValue;
                                delete data.multiplierMin;
                                delete data.timeMinOp;
                            }
                            if (data.timeMaxType) {
                                if (!data.timeMax && data.timeMaxType !== types.Undefined.value) {
                                    data.timeMax = {
                                        type            : data.timeMaxType,
                                        value           : (data.timeMaxValue || ''),
                                        offsetType      : (data.offsetMaxType || types.Undefined.value),
                                        offset          : (data.offsetMaxValue || '1'),
                                        multiplier      : (parseInt(data.multiplierMax) || 60000)
                                    };
                                }
                                delete data.timeMaxType;
                                delete data.timeMaxValue;
                                delete data.offsetMaxType;
                                delete data.offsetMaxValue;
                                delete data.multiplierMax;
                                delete data.timeMaxOp;
                            }
                            if (data.levelType) {
                                if (!data.level) {
                                    data.level = {
                                        type            : (data.levelType || types.LevelFix.value),
                                        value           : (data.levelValue || 'closed (min)'),
                                        operator        : (parseInt(data.levelOp) || 0),
                                        operatorText    : data.levelOpText || node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelAbs')
                                    };
                                }
                                if ((data.level.operator === 3) || (data.level.operator === 4)) {
                                    data.level.operator.type = types.LevelND.value;
                                    data.level.operator.value = '';
                                    data.level.operator = data.level.operator - 2;
                                }
                                delete data.levelType;
                                delete data.levelValue;
                                delete data.levelOp;
                                delete data.levelOpText;
                            } else if (!data.level) {
                                data.level = {
                                    type            : types.LevelFix.value, // types.LevelND.value,
                                    value           : types.LevelFix.options[0].value // ''
                                };
                            }
                            if (!data.slat) {
                                data.slat = {
                                    type            : types.Undefined.value,
                                    value           : ''
                                };
                            }
                            if (!data.description || !data.version || data.version !== ruleVersion) {
                                data.description = getRuleDescription(node, selFields, data);
                                data.version = ruleVersion;
                            }
                            $containerRow.data('ruleData', JSON.stringify(data));
                            $containerRow.css({ overflow: 'hidden'}); // , whiteSpace: 'nowrap'

                            const $row0 = $('<div/>', {
                                class: 'rdgtimer-rule-row'
                            }).appendTo($containerRow);
                            const $div = $('<div/>', {
                                class: 'rdgtimer-rule-mainblock'
                            }).appendTo($row0);
                            $('<span />', {
                                id: 'rule-name-'+containerIndex,
                                class: 'rdgtimer-rule-name-span'
                            }).append(data.name || 'rule ' + (containerIndex + 1)).appendTo( $div );
                            $('<div />', {
                                id: 'rule-description-'+containerIndex,
                                class: 'rdgtimer-rule-description-span'
                            }).append(data.description).appendTo( $div );
                            const finalspan1 = $('<span/>',{
                                class:'rdgtimer-rule-finalspan'
                            }).appendTo($row0);
                            finalspan1.append('<span class="node-input-rule-index">'+(containerIndex+1)+'</span> ');

                            const $ctrldiv = $('<div />', {
                                class:'rdgtimer-rule-ctrl-div'
                            }).appendTo( $row0 );
                            const $btnEdit = $('<a />', {
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-editBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.editRule')
                            }).append('<i class= "fa fa-pencil-square-o" ></i>').appendTo($ctrldiv);
                            const $btnCpy = $('<a />', {
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-duplicateBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.duplicateRule')
                            }).append('<i class= "fa fa-clone" ></i>').appendTo($ctrldiv);
                            const $btnState = $('<a />', {
                                id: 'rule-btn-state-'+containerIndex,
                                class: 'red-ui-button red-ui-button-small rdgtimer-rule-stateBtn',
                                title: node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleState')
                            }).append('<i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i>').appendTo($ctrldiv);

                            $btnEdit.click(() => {
                                _dialogLoadData(containerIndex, $containerRow);
                            });
                            $btnCpy.click(() => {
                                _dialogDuplicateRule(containerIndex, $containerRow);
                            });
                            $btnState.click(() => {
                                const data = JSON.parse($containerRow.data('ruleData'));
                                data.enabled = (data.enabled === false || data.enabled === 'false');
                                $containerRow.data('ruleData', JSON.stringify(data));
                                $btnState.trigger('setRuleEnabledState');
                            });
                            $btnState.bind('setRuleEnabledState',() => {
                                const data = JSON.parse($containerRow.data('ruleData'));
                                const en = !(data.enabled === false || data.enabled === 'false');
                                $row0.toggleClass('rule-disabled', !en );
                                if (en) {
                                    $btnState.find('.fa-circle-thin').show();
                                    $btnState.find('.fa-ban').hide();
                                } else {
                                    $btnState.find('.fa-circle-thin').hide();
                                    $btnState.find('.fa-ban').show();
                                }
                            });
                            $btnState.trigger('setRuleEnabledState');
                            resizeRuleContainerCheck(node);
                        },
                        addButton: false,
                        sortable: true,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem(_opt) {
                            $('#node-input-rule-container').editableList('items').each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                            resizeRuleContainerCheck(node);
                        },
                        sortItems(rules) {
                            rules.each(function(i) {
                                $(this).find('.node-input-rule-index').html(i+1);
                                const data = $(this).data('data');
                                data.index = i;
                            });
                        }
                    });

                    // #region Button
                    const $btnAdd = $('#node-button-add');
                    $btnAdd.click(() => {
                        $('#node-input-rule-container').editableList('addItem', {});
                        resizeRuleContainerCheck(node);
                    });

                    const $btnClear = $('#node-button-clear');
                    $btnClear.click(() => {
                        $('#node-input-rule-container').editableList('empty');
                        resizeRuleContainerCheck(node);
                    });

                    const $btnSort = $('#node-button-sort');
                    $btnSort.click(() => {
                        $('#node-input-rule-container').editableList('items').each(function(i) {
                            const data = $(this).data('data');
                            data.index = i;
                            // data.conditional = ((data.conditions.length > 0) ? 1 : 0);
                            // data.timeLimited = ((data.time && data.time.type !== 'none') ? 1 : 0);
                            data.timeData = (parseFloat($(this).find('.node-input-rule-timeReg').attr('timedata')) || 0);
                        });
                        /**
                         * 1 no time
                         * 2 time    - until
                         * 3 time    - from
                         */
                        $('#node-input-rule-container').editableList('sort', (a, b) => {
                            const pos = (a.index - b.index);
                            if (!a.time && !b.time) { // both not time limited
                                return pos;
                            }
                            // both are time limited
                            const atimeop = (a.time) ? (Number(a.time.operator) || 0) : -1;
                            const btimeop = (b.time) ? (Number(b.time.operator) || 0) : -1;
                            const top = (atimeop - btimeop);
                            if (top !== 0) {
                                return top; // from before until; not timeLimited before timeLimited (1-3)
                            }

                            const time = a.timeData - b.timeData;
                            if ((a.timeData !== 0) && (b.timeData !== 0) && (time !== 0)) { // time is different
                                return time;
                            }
                            return pos;
                        });
                        $('#node-input-rule-container').editableList('items').each(function(i) {
                            $(this).find('.node-input-rule-index').html(i+1);
                            const data = $(this).data('data');
                            data.index = i;
                        });
                    });

                    const $btnExport = $('#node-button-export');
                    $btnExport.click(() => {
                        const rules = [];
                        $('#node-input-rule-container').editableList('items').each(function (_i) {
                            const rule = $(this);
                            const data = JSON.parse(rule.data('ruleData'));
                            delete data.description; // will causte trouble
                            data.index = _i;
                            rules.push(data);
                        });
                        console.log('export to clipboard', rules); // eslint-disable-line no-console
                        navigator.clipboard.writeText(JSON.stringify(rules, null, '\t'));
                    });

                    const $btnImport = $('#node-button-import');
                    $btnImport.click(() => {
                        navigator.clipboard.readText().then(
                            clipText => {
                                try {
                                    const rules = JSON.parse(clipText);
                                    console.log('import from clipboard', rules); // eslint-disable-line no-console
                                    if (Array.isArray(rules)) {
                                        for (let i = 0; i < rules.length; i++) {
                                            const rule = rules[i];
                                            if (typeof rule.name === 'string' &&
                                                rule.version) {
                                                $('#node-input-rule-container').editableList('addItem', rule);
                                            }
                                        }
                                    }
                                    resizeRuleContainerCheck(node);
                                } catch (err) {
                                    console.log(err.message); // eslint-disable-line no-console
                                    console.log(err.stack); // eslint-disable-line no-console
                                    alert(`Clipboard Data has wrong Format! (${err.message})`);
                                }
                            });
                    });
                    // #endregion Button
                    // fill rules
                    if (node.rules) {
                        $('#node-input-rule-container').editableList('empty');
                        for (let i = 0; i < node.rules.length; i++) {
                            const rule = node.rules[i];
                            // rule.index = i;
                            $('#node-input-rule-container').editableList('addItem', rule);
                        }
                        resizeRuleContainerCheck(node);
                    }
                    // #endregion rules
                    // #region sun
                    $('#node-input-sunControlMode').on('change focus focusin focusout', (_type, _value) => {
                        const val= Number($('#node-input-sunControlMode').val());
                        if (val === cNBC_MODE_SUN_CONTROL) {
                            $('.form-row-sunControlActive').show();
                            $('.form-row-sunControlRestriction').show();
                            $('.form-row-sunControlMaximization').hide();
                            $('.form-row-sunControlMinimization').hide();
                            resizeOversteerContainer();
                        } else if (val === cNBC_MODE_MAXIMIZE ) {
                            $('.form-row-sunControlActive').show();
                            $('.form-row-sunControlRestriction').hide();
                            $('.form-row-sunControlMaximization').show();
                            $('.form-row-sunControlMinimization').hide();
                            resizeOversteerContainer();
                        } else if (val === cNBC_MODE_MINIMIZE) {
                            $('.form-row-sunControlActive').show();
                            $('.form-row-sunControlRestriction').hide();
                            $('.form-row-sunControlMaximization').hide();
                            $('.form-row-sunControlMinimization').show();
                            resizeOversteerContainer();
                        } else {
                            $('.form-row-sunControlActive').hide();
                            $('.form-row-sunControlRestriction').hide();
                            $('.form-row-sunControlMaximization').hide();
                            $('.form-row-sunControlMinimization').hide();
                            $('.row-oversteerTopic').hide();
                        }
                    });
                    setupTInput(node, {
                        typeProp: 'blindPosMinType',
                        valueProp: 'blindPosMin',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosMinType, node.blindPosMin, 'closed (min)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'blindPosMaxType',
                        valueProp: 'blindPosMax',
                        width: 'calc(100% - 120px)',
                        defaultType: types.LevelFix.value,
                        defaultValue: getDefLevel(node.blindPosMaxType, node.blindPosMax, 'open (max)'),
                        types: [types.LevelFix, types.LevelEntered, 'env']
                    });
                    setupTInput(node, {
                        typeProp: 'sunSlatType',
                        valueProp: 'sunSlat',
                        width: 'calc(100% - 120px)',
                        defaultType: types.Undefined.value,
                        defaultValue: '',
                        types: [
                            types.Undefined,
                            'str',
                            'num',
                            'bool',
                            types.MsgPayload,
                            types.MsgValue,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata'
                        ]
                    });

                    setMultiplier(node, 'smoothTime', v => {
                        const n = parseFloat(v);
                        return (v === '') || (RED.validators.number()(v) && (n >= -2147483647) && (n < 0x7FFFFFFF));
                    }, 60000);
                    // #endregion sun
                    // #region oversteering
                    /**  resizes a rule container */
                    function resizeOversteerContainer() {
                        // const editorRow = $('.node-input-oversteer-container-row ol');
                        // const height =  editorRow.outerHeight(true);
                        const $container = $('#node-input-oversteer-container');
                        const height =  $container.outerHeight(true);
                        const rowCount = $container.editableList('length');
                        if (rowCount > 0) {
                            // $container.editableList('height', height + 40);
                            $container.css('min-height', height + 'px');
                            if (Number($('#node-input-sunControlMode').val()) <= cNBC_MODE_OFF) {
                                $('.row-oversteerTopic').hide();
                            } else {
                                $('.row-oversteerTopic').show();
                            }
                        } else {
                            // $container.editableList('height', 10);
                            $container.css('min-height', '20px');
                            $('.row-oversteerTopic').hide();
                        }
                    }

                    $('#node-input-oversteer-container').css('min-width', '400px').editableList({
                        addItem(containerRow, containerIndex, data) {
                            if (!data || !Object.prototype.hasOwnProperty.call(data, 'value')) {
                                data = {
                                    valueType       : 'msg',           // operand type
                                    value           : '',              // operand
                                    operator        : 'gte',           // operator
                                    operatorText    : '>=',            // operator
                                    thresholdType   : 'num',           // threshold type
                                    threshold       : '',              // threshold
                                    mode            : 0,
                                    onlySunInWindow : true,
                                    blindPos        : {
                                        type        : 'levelFixed',
                                        value       : 'open (max)'
                                    },
                                    slatPos         : {
                                        type        : types.Undefined.value,
                                        value       : ''
                                    }
                                };
                            }
                            if (!Object.prototype.hasOwnProperty.call(data, 'onlySunInWindow')) {
                                data.onlySunInWindow = true;
                            }

                            containerRow.css({overflow: 'hidden', whiteSpace: 'nowrap'});
                            const $row1 = $('<div/>').appendTo(containerRow);
                            const $row2 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            const $row3 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            const $row4 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            const $row5 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            // row1 - index + oversteerValue + Compare
                            $('<input/>',{
                                type: 'hidden',
                                id:'node-input-oversteer-index' + containerIndex,
                                class:'node-input-oversteer-index',
                                value:(containerIndex+1)
                            }).appendTo($row1);

                            const $oversteerValue = $('<input/>', {
                                class: 'node-input-oversteer-value',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 90px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        'msg',
                                        types.MsgPayload,
                                        types.MsgValue,
                                        types.MsgPayloadByTopic,
                                        'flow',
                                        'global',
                                        'env',
                                        'jsonata',
                                        types.SunInSky,
                                        types.SunAzimuth,
                                        types.SunElevation,
                                        types.PhaseMoon,
                                        types.isDST,
                                        types.WeekOfYear,
                                        types.WeekOfYearEven,
                                        types.DayOfYear,
                                        types.DayOfYearEven
                                    ]
                                });
                            setTInputValue($oversteerValue, data.value, data.valueType);

                            const $oversteerCompare = $('<select/>', {
                                class: 'node-input-oversteer-compare',
                                id: 'node-input-oversteer-compare' + containerIndex
                            })
                                .css('width', '90px')
                                .appendTo($row1);
                            appendOptions(node, $oversteerCompare, 'comparator');
                            $oversteerCompare.val(data.operator || 'gte');

                            // row2 - Thersold
                            addLabel($row2, 'node-input-oversteer-compare', 'fa fa-cloud', node._('blind-control.label.oversteerThreshold'), '95px');

                            const $oversteerThreshold = $('<input/>', {
                                class: 'node-input-oversteer-threshold',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 162px)')
                                .appendTo($row2)
                                .typedInput({
                                    default: 'num',
                                    types: [
                                        'num',
                                        types.numAzimuth,
                                        types.numAltitude,
                                        'str',
                                        'bool',
                                        'flow',
                                        'global',
                                        'env',
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek
                                    ]
                                });
                            setTInputValue($oversteerThreshold, data.threshold, data.thresholdType);

                            const $oversteerMode = $('<select/>', {
                                class: 'node-input-oversteer-mode',
                                id: 'node-input-oversteer-mode' + containerIndex
                            })
                                .css('width', '60px')
                                .appendTo($row2);
                            $oversteerMode.append($('<option></option>').val(0).text(node._('blind-control.label.sunControlNoMatter')));
                            $oversteerMode.append($('<option></option>').val(1).text(node._('blind-control.label.sunControlRestrictOnly')));
                            $oversteerMode.append($('<option></option>').val(2).text(node._('blind-control.label.sunControlMaximizeOnly')));
                            $oversteerMode.append($('<option></option>').val(2).text(node._('blind-control.label.sunControlMinimizeOnly')));
                            $oversteerMode.val(data.mode || 0);
                            // row3 - BlindPos
                            addLabel($row3, 'node-input-oversteer-blindPos', 'fa fa-angle-down', node._('blind-control.label.oversteerBlindPos'), '140px');

                            const $oversteerBlindPos = $('<input/>', {
                                class: 'node-input-oversteer-blindPos',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 147px)')
                                .appendTo($row3)
                                .typedInput({
                                    default: types.LevelFix,
                                    types: [types.LevelFix, types.LevelEntered, 'env']
                                });
                            setTInputValue($oversteerBlindPos, data.blindPos.value, data.blindPos.type);
                            // row4 - BlindSlat
                            addLabel($row4, 'node-input-oversteer-slatPos', 'fa fa-slack', node._('blind-control.label.oversteerSlatPos'), '140px');
                            const $oversteerSlatPos = $('<input/>', {
                                class: 'node-input-oversteer-slatPos',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 147px)')
                                .appendTo($row4)
                                .typedInput({
                                    default: 'num',
                                    types: [
                                        types.Undefined,
                                        'str',
                                        'num',
                                        'bool',
                                        types.MsgPayload,
                                        types.MsgValue,
                                        'msg',
                                        'flow',
                                        'global',
                                        'json',
                                        'bin',
                                        'env',
                                        'jsonata',
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek
                                    ]
                                });
                            setTInputValue($oversteerSlatPos, data.slatPos.value, data.slatPos.type);

                            // row5 - SunInWindow
                            addLabel($row5, 'node-input-oversteer-sunInWindow', 'fa fa-window-maximize', node._('blind-control.label.oversteerSunInWindow'));
                            const $oversteerOnlySunInWindow = $('<input/>', {
                                class: 'node-input-oversteer-sunInWindow',
                                type: 'checkbox'
                            })
                                .css('width', 'auto')
                                .css('margin-left', '10px')
                                .css('margin-top', '0')
                                .appendTo($row5);
                            $oversteerOnlySunInWindow.prop('checked', data.onlySunInWindow);

                            // changes
                            $oversteerValue.change(() => {
                                $oversteerThreshold.change();
                                const oversteerValueType = $oversteerValue.typedInput('type');
                                if (oversteerValueType === 'jsonata' ||
                                        oversteerValueType === types.PhaseMoon.value ||
                                        oversteerValueType === types.MsgPayloadByTopic.value) {
                                    $oversteerCompare.attr('disabled', true);
                                    $oversteerCompare.val(selFields.comparator[0].id); // only true is valid for jsonata
                                    $row2.hide();
                                } else {
                                    $oversteerCompare.attr('disabled', false);
                                    if (getOperandCount(selFields, $oversteerCompare.val()) > 1) {
                                        $row2.show();
                                    } else {
                                        $row2.hide();
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        $oversteerValue.attr('title', d.value);
                                        $row1.attr('title', d.value);
                                    } else {
                                        $oversteerValue.attr('title', '');
                                        $row1.attr('title', '');
                                    }
                                    _dialogGenHelpText();
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           oversteerValueType,
                                    value:          $oversteerValue.typedInput('value'),
                                    noOffsetError:  true
                                });
                                $oversteerBlindPos.change();
                                $oversteerSlatPos.change();
                                resizeOversteerContainer();
                            });
                            $oversteerCompare.change(() => {
                                $oversteerValue.change();
                            });
                            $oversteerThreshold.change(() => {
                                const oversteerValueType = $oversteerValue.typedInput('type');
                                if (oversteerValueType === types.SunAzimuth.value) {
                                    const thresholdValueType = $oversteerThreshold.typedInput('type');
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $oversteerThreshold.typedInput('type', types.numAzimuth.value);
                                    }
                                } else if (oversteerValueType === types.SunElevation.value) {
                                    const thresholdValueType = $oversteerThreshold.typedInput('type');
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $oversteerThreshold.typedInput('type', types.numAltitude.value);
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        $oversteerThreshold.attr('title', d.value);
                                        $row2.attr('title', d.value);
                                    } else {
                                        $oversteerThreshold.attr('title', '');
                                        $row2.attr('title', '');
                                    }
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           $oversteerThreshold.typedInput('type'),
                                    value:          $oversteerThreshold.typedInput('value'),
                                    noOffsetError:  true
                                });
                            });
                            $oversteerValue.change();
                            $oversteerThreshold.change();
                            resizeOversteerContainer();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                $(this).find('.node-input-oversteer-index').html(i + 1);
                            });
                        },
                        // resizeItem: resizeRule,
                        addButton: false,
                        sortable: true,
                        removable: true,
                        scrollOnAdd: true,
                        removeItem: resizeOversteerContainer
                    }); // oversteer-container

                    if (!node.oversteers) {
                        node.oversteers = [];
                        if (node.sunMinAltitude) {
                            node.oversteers.push({
                                valueType       : 'pdsCalcElevation',
                                value           : '',
                                operator        : 'lt',
                                operatorText    : '<',
                                thresholdType   : types.numAltitude.value,
                                threshold       : node.sunMinAltitude,
                                mode            : 2,
                                blindPos        : {
                                    type        : node.blindPosDefaultType,
                                    value       : node.blindPosDefault
                                },
                                slatPos         : {
                                    type        : types.Undefined.value,
                                    value       : ''
                                }
                            });
                        }
                        if (node.oversteerValueType && (node.oversteerValueType !== types.Undefined.value)) {
                            node.oversteers.push({
                                valueType       : node.oversteerValueType,
                                value           : node.oversteerValue,
                                operator        : node.oversteerCompare,
                                thresholdType   : node.oversteerThresholdType,
                                threshold       : node.oversteerThreshold,
                                mode            : 0,
                                blindPos        : {
                                    type        : node.oversteerBlindPosType,
                                    value       : node.oversteerBlindPos
                                },
                                slatPos         : {
                                    type        : types.Undefined.value,
                                    value       : ''
                                }
                            });
                            if (node.oversteer2ValueType && (node.oversteer2ValueType !== types.Undefined.value)) {
                                node.oversteers.push({
                                    valueType       : node.oversteer2ValueType,
                                    value           : node.oversteer2Value,
                                    operator        : node.oversteer2Compare,
                                    thresholdType   : node.oversteer2ThresholdType,
                                    threshold       : node.oversteer2Threshold,
                                    mode            : 0,
                                    blindPos        : {
                                        type        : node.oversteer2BlindPosType,
                                        value       : node.oversteer2BlindPos
                                    },
                                    slatPos         : {
                                        type        : types.Undefined.value,
                                        value       : ''
                                    }
                                });
                                if (node.oversteer3ValueType && (node.oversteer3ValueType !== types.Undefined.value)) {
                                    node.oversteers.push({
                                        valueType       : node.oversteer3ValueType,
                                        value           : node.oversteer3Value,
                                        operator        : node.oversteer3Compare,
                                        thresholdType   : node.oversteer3ThresholdType,
                                        threshold       : node.oversteer3Threshold,
                                        mode            : 0,
                                        blindPos        : {
                                            type        : node.oversteer3BlindPosType,
                                            value       : node.oversteer3BlindPos
                                        },
                                        slatPos         : {
                                            type        : types.Undefined.value,
                                            value       : ''
                                        }
                                    });
                                }
                            }
                        }
                    }
                    $('#node-input-oversteer-container').editableList('empty');
                    for (let i = 0; i < node.oversteers.length; i++) {
                        $('#node-input-oversteer-container').editableList('addItem', node.oversteers[i]);
                    }
                    resizeOversteerContainer();

                    // #region oversteer Button
                    const $btnOversteerAdd = $('#node-oversteer-button-add');
                    $btnOversteerAdd.click(() => {
                        $('#node-input-oversteer-container').editableList('addItem', {});
                        resizeOversteerContainer();
                    });

                    const $btnOversteerClear = $('#node-oversteer-button-clear');
                    $btnOversteerClear.click(() => {
                        $('#node-input-oversteer-container').editableList('empty');
                        resizeOversteerContainer();
                    });
                    const $btnOversteerExport = $('#node-oversteer-button-export');
                    $btnOversteerExport.click(() => {
                        const exprules = [];
                        $('#node-input-oversteer-container').editableList('items').each(function(_i) {
                            const $rule = $(this);
                            const p = {
                                mode            : parseInt($rule.find('.node-input-oversteer-mode').val()),
                                valueType       : $rule.find('.node-input-oversteer-value').typedInput('type'),
                                value           : $rule.find('.node-input-oversteer-value').typedInput('value'),
                                operator        : $rule.find('.node-input-oversteer-compare').val(),
                                operatorText    : $rule.find('.node-input-oversteer-compare option:selected').text(),
                                thresholdType   : $rule.find('.node-input-oversteer-threshold').typedInput('type'),
                                threshold       : $rule.find('.node-input-oversteer-threshold').typedInput('value'),
                                blindPos        : {
                                    type        : $rule.find('.node-input-oversteer-blindPos').typedInput('type'),
                                    value       : $rule.find('.node-input-oversteer-blindPos').typedInput('value')
                                },
                                slatPos         : {
                                    type        : $rule.find('.node-input-oversteer-slatPos').typedInput('type'),
                                    value       : $rule.find('.node-input-oversteer-slatPos').typedInput('value')
                                }
                            };
                            if (p.thresholdType === 'num' && p.threshold === '') {
                                p.threshold = 0;
                            }
                            exprules.push(p);
                        });
                        console.log('export to clipboard', exprules); // eslint-disable-line no-console
                        navigator.clipboard.writeText(JSON.stringify(exprules, null, '\t'));
                    });

                    const $btnOversteerImport = $('#node-oversteer-button-import');
                    $btnOversteerImport.click(() => {
                        navigator.clipboard.readText().then(
                            clipText => {
                                try {
                                    const rules = JSON.parse(clipText);
                                    console.log('import from clipboard', rules); // eslint-disable-line no-console
                                    if (Array.isArray(rules)) {
                                        for (let i = 0; i < rules.length; i++) {
                                            const rule = rules[i];
                                            if (typeof rule.mode === 'number' &&
                                                typeof rule.valueType === 'string' &&
                                                rule.blindPos && rule.slatPos && rule.blindPos.type && rule.slatPos.type) {
                                                // rule.index = i;
                                                $('#node-input-oversteer-container').editableList('addItem', rule);
                                            }
                                        }
                                    }
                                    resizeOversteerContainer();
                                } catch (err) {
                                    console.log(err.message); // eslint-disable-line no-console
                                    console.log(err.stack); // eslint-disable-line no-console
                                    alert(`Clipboard Data has wrong Format! (${err.message})`);
                                }
                            });
                    });
                    // #endregion oversteer Button
                    // #endregion oversteering
                    // #region result-container
                    /** resizes result container */
                    function resizeResultContainer() {
                        const editorRow = $('.node-input-result-container-row ol');
                        const height = editorRow.outerHeight(true);
                        const rowCount = $('#node-input-result-container').editableList('length');
                        if (rowCount > 0) {
                            $('#node-input-result-container').css('min-height', height + 'px');
                        } else {
                            $('#node-input-result-container').css('min-height', '20px');
                        }
                    }

                    $('#node-input-result-container').css('min-height', '40px').css('min-width', '400px').editableList({
                        addItem($containerRow, containerIndex, data) {
                            $containerRow.css({ overflow: 'hidden', whiteSpace: 'nowrap' });
                            const $row1 = $('<div/>').appendTo($containerRow);
                            // row1 - Property / Type Selection
                            let prop = data;
                            if (!Object.prototype.hasOwnProperty.call(prop, 'p')) {
                                prop = {
                                    p: '',
                                    pt: types.MsgPayload.value,
                                    v: '',
                                    vt: types.OutputLevel.value
                                };
                            }
                            if (prop.p === 'payload' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgPayload.value;
                            } else if (prop.p === 'topic' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgTopic.value;
                            } else if (prop.p === 'value' && (!prop.pt || prop.pt === 'msg')) {
                                prop.pt = types.MsgValue.value;
                            }
                            const $propertyName = $('<input/>', {
                                class: 'node-input-prop-result-name',
                                type: 'text'
                            })
                                .css('width', '40%')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        types.MsgPayload,
                                        types.MsgTopic,
                                        types.MsgValue,
                                        types.MsgTs,
                                        types.MsgLc,
                                        'msg',
                                        'flow',
                                        'global'
                                    ]
                                });
                            setTInputValue($propertyName, prop.p, prop.pt);

                            $('<div/>', { style: 'display:inline-block; padding:0px 6px;' })
                                .text('=')
                                .appendTo($row1);
                            const $propertyValue = $('<input/>', {
                                class: 'node-input-prop-result-value',
                                type: 'text'
                            })
                                .css('width', 'calc(60% - 30px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: 'input',
                                    types: [
                                        types.OutputLevel,
                                        types.OutputLevelInverse,
                                        types.OutputSlat,
                                        types.OutputTopic,
                                        types.OutputCtrlObj,
                                        'date',
                                        'str',
                                        types.strPlaceholder,
                                        'num',
                                        'bool',
                                        'json',
                                        'bin',
                                        'env',
                                        'msg',
                                        'flow',
                                        'global',
                                        'jsonata',
                                        types.randomNumber,
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek,
                                        types.nodeId,
                                        types.nodeName,
                                        types.nodePath
                                    ]
                                });
                            setTInputValue($propertyValue, prop.v, prop.vt);

                            // changes
                            $propertyValue.change(() => {
                                // $operand.show();
                                // const plNType = $propertyName.typedInput('type');
                                const plVType = $propertyValue.typedInput('type');
                                const plVValue = $propertyValue.typedInput('value');
                                if (plVValue === 'input') {
                                    $containerRow.attr('title', $('#node-input-input').attr('title'));

                                } else {
                                    getBackendData(d => {
                                        $containerRow.attr('title', bdDateToTime(d));
                                    }, {
                                        nodeId:         node.id,
                                        kind:           'getOutDataData',
                                        config:         $nodeConfig.val(),
                                        type:           plVType,
                                        value:          plVValue
                                    });
                                }
                                resizeResultContainer();
                            });
                            $propertyValue.change();
                            resizeResultContainer();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                $(this).find('.node-input-rule-index').html(i + 1);
                            });
                        },
                        // resizeItem: resizeRule,
                        sortable: true,
                        removable: true,
                        removeItem: resizeResultContainer
                    });

                    if (!node.results) {
                        node.results = [
                            {
                                p: '',
                                pt: 'msgTopic',
                                v: '',
                                vt: 'topic'
                            },
                            {
                                p: '',
                                pt: 'msgPayload',
                                v: '',
                                vt: 'level'
                            },
                            {
                                p: 'slat',
                                pt: 'msg',
                                v: '',
                                vt: 'slat'
                            },
                            {
                                p: 'blindCtrl',
                                pt: 'msg',
                                v: '',
                                vt: types.OutputCtrlObj.value
                            }
                        ];
                    }
                    for (let i = 0; i < node.results.length; i++) {
                        const res = node.results[i];
                        $('#node-input-result-container').editableList('addItem', res);
                    }
                    // #endregion result-container
                    // #region Enhanced settings
                    $('.spinner-level').spinner({
                        max: 100,
                        min: 0,
                        step: 0.01,
                        numberFormat: 'n'
                    });
                    $('.spinner-time').spinner({
                        max: 1439,
                        min: 0,
                        step: 1
                    });
                    $('#node-input-autoTrigger').change( () => {
                        if ($('#node-input-autoTrigger').is(':checked')) {
                            $('#blind-control-autoTriggerTime-edit').show();
                        } else {
                            $('#blind-control-autoTriggerTime-edit').hide();
                        }
                    });
                    $('#node-input-autoTrigger').change();
                    // #endregion Enhanced settings
                    // #region dialog
                    const $dialog = $('#dialog-edit-rule').dialog({
                        title: node._('blind-control.label.dialogtitle'),
                        autoOpen: false,
                        resizable: true,
                        height: Math.min(750, $(window).height() * 0.9), // 1024
                        width: Math.min(850, $(window).width() * 0.9),
                        modal: true,
                        closeOnEscape: true,
                        classes : {
                            'ui-dialog': 'ui-dialog-rdg ',
                            'ui-dialog-content': 'ui-dialog-content-rdg ',
                            'ui-dialog-titlebar': 'ui-dialog-titlebar-rdg'
                        },
                        buttons: [
                            {
                                text: 'state',
                                'class': 'dialog-stateBtn',
                                'id': 'dlg-ip-btctl-rule-state',
                                click() {
                                    const $btn = $('#dialog-edit-rule').parent().find('#dlg-ip-btctl-rule-state');
                                    const state = !($btn.attr('is_enabled') === false || $btn.attr('is_enabled') === 'false');
                                    $btn.attr('is_enabled', !state);
                                    $btn.trigger('setRuleEnabledState');
                                }
                            },
                            {
                                text: node._('node-red-contrib-sun-position/position-config:common.label.ok'),
                                icons: { primary: 'ui-icon-check' },
                                click() {
                                    _dialogSaveData();
                                    $dialog.dialog( 'close' );
                                    $dialogDataRow = null;
                                    dialogDataIndex = -1;
                                }
                            },
                            {
                                text: node._('node-red-contrib-sun-position/position-config:common.label.cancel'),
                                icons: { primary: 'ui-icon-closethick' },
                                click() {
                                    $dialog.dialog( 'close' );
                                    $dialogDataRow = null;
                                    dialogDataIndex = -1;
                                }
                            }
                        ],
                        dialogClass: 'overflow-fix',
                        close() {
                            $dialog.dialog( 'close' );
                            $dialogDataRow = null;
                            dialogDataIndex = -1;
                        }
                    });

                    const $dialogName = $dialog.find('#dlg-ip-btctl-rule-name');
                    let $dialogDataRow = null;
                    let dialogDataOnLoading = false;
                    let dialogDataIndex = -1;
                    const $dialogRuleEnableBtn = $dialog.parent().find('#dlg-ip-btctl-rule-state');
                    $dialogRuleEnableBtn.append('<i class="fa fa-circle-thin"></i><i class="fa fa-ban"></i>');
                    $dialogRuleEnableBtn.bind('setRuleEnabledState',() => {
                        const state = !($dialogRuleEnableBtn.attr('is_enabled') === false || $dialogRuleEnableBtn.attr('is_enabled') === 'false');
                        $dialog.toggleClass('rule-disabled', state );
                        if (state) {
                            $dialogRuleEnableBtn.text(' '+node._('node-red-contrib-sun-position/position-config:common.label.enabled'));
                            $dialogRuleEnableBtn.prepend('<i class="fa fa-circle-thin"></i>');
                        } else {
                            $dialogRuleEnableBtn.text(' '+node._('node-red-contrib-sun-position/position-config:common.label.disabled'));
                            $dialogRuleEnableBtn.prepend('<i class="fa fa-ban"></i>');
                        }
                    });
                    // #region dialogConditions
                    const $dialogConditionContainer = $dialog.find('#dlg-ip-btctl-rule-condition-container');
                    /** resizes a rule container */
                    function resizeConditionContainer() {
                        const editorRow = $('.dlg-ip-btctl-rule-condition-container-row ol');
                        const height =  editorRow.outerHeight(true);
                        const rowCount = $('#node-input-rule-container').editableList('length');
                        if (rowCount > 0) {
                            $dialogConditionContainer.editableList('height', height + 30);
                        } else {
                            $dialogConditionContainer.editableList('height', 0);
                        }
                    }

                    $dialogConditionContainer.css('min-width', '400px').editableList({
                        addItem(containerRow, containerIndex, data) {
                            if (!Object.prototype.hasOwnProperty.call(data, 'value')) {
                                data = {
                                    condition       : 1,        // condition
                                    valueType       : 'msg',    // operand type
                                    value           : '',       // operand
                                    operator        : 'gte',    // operator
                                    operatorText    : '>=',
                                    thresholdType   : 'num',    // threshold type
                                    threshold       : ''        // threshold
                                };
                            }

                            containerRow.css({overflow: 'hidden', whiteSpace: 'nowrap'});
                            const $row1 = $('<div/>').appendTo(containerRow);
                            const $row2 = $('<div/>', {style: 'padding-top: 5px;'}).appendTo(containerRow);
                            // row1 - index + logOperator + condOperand
                            $('<input/>',{
                                type: 'hidden',
                                id:'dlg-ip-btctl-rule-condIndex' + containerIndex,
                                class:'dlg-ip-btctl-rule-condIndex',
                                value:(containerIndex+1)
                            }).appendTo($row1);

                            const $dialogCondLogOperator = $('<select/>', {
                                class: 'dlg-ip-btctl-rule-condLogOperator',
                                id: 'dlg-ip-btctl-rule-condLogOperator' + containerIndex
                            })
                                .css('width', '90px')
                                .css('margin-bottom', '0px')
                                .appendTo($row1);
                            $dialogCondLogOperator.append($('<option></option>').val(1).text(node._('node-red-contrib-sun-position/position-config:common.label.or')));
                            $dialogCondLogOperator.append($('<option></option>').val(2).text(node._('node-red-contrib-sun-position/position-config:common.label.and')));
                            $dialogCondLogOperator.val(data.condition || 1);

                            const $dialogCondOperand = $('<input/>', {
                                class: 'dlg-ip-btctl-rule-condOperand',
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 95px)')
                                .appendTo($row1)
                                .typedInput({
                                    default: types.MsgPayload.value,
                                    types: [
                                        types.Unlimited,
                                        'msg',
                                        'flow',
                                        'global',
                                        'env',
                                        'jsonata',
                                        types.PhaseMoon,
                                        types.MsgPayload,
                                        types.MsgValue,
                                        types.MsgPayloadByTopic,
                                        types.SunInSky,
                                        types.SunAzimuth,
                                        types.SunElevation,
                                        types.isDST,
                                        types.WeekOfYear,
                                        types.WeekOfYearEven,
                                        types.DayOfYear,
                                        types.DayOfYearEven,
                                        types.SunControlModeType,
                                        types.nodeId,
                                        types.nodeName,
                                        types.nodePath
                                    ]
                                });
                            setTInputValue($dialogCondOperand, data.value, data.valueType);

                            // row2 - compare + Thersold
                            const $dialogCondOperator = $('<select/>', {
                                class: 'dlg-ip-btctl-rule-condOperator',
                                id: 'dlg-ip-btctl-rule-condOperator' + containerIndex
                            })
                                .css('width', '140px')
                                .css('margin-bottom', '0px')
                                .appendTo($row2);
                            appendOptions(node, $dialogCondOperator, 'comparator');
                            $dialogCondOperator.val(data.operator || 'gte');

                            const $dialogCondThreshold = $('<input/>', {
                                class: 'dlg-ip-btctl-rule-condThreshold',
                                id: 'dlg-ip-btctl-rule-condThreshold' + containerIndex,
                                type: 'text'
                            })
                                .css('width', 'calc(100% - 145px)')
                                .appendTo($row2)
                                .typedInput({
                                    default: 'num',
                                    types: [
                                        'num',
                                        types.numAzimuth,
                                        types.numAltitude,
                                        'str',
                                        'bool',
                                        'flow',
                                        'global',
                                        'env',
                                        types.randmNumCachedDay,
                                        types.randmNumCachedWeek
                                    ]
                                });
                            setTInputValue($dialogCondThreshold, data.threshold, data.thresholdType);
                            // changes
                            $dialogCondOperand.change(() => {
                                $dialogCondThreshold.change();
                                // if (dialogDataOnLoading) { return; }
                                const propType = $dialogCondOperand.typedInput('type');
                                if (propType === types.PhaseMoon.value ||
                                        propType === types.MsgPayloadByTopic.value ||
                                        propType === types.SunControlModeType.value) {
                                    $dialogCondOperator.val(selFields.comparator[0].id); // only true is valid
                                    $dialogCondOperator.attr('disabled', true);
                                    $dialogCondOperator.hide();
                                    $dialogCondThreshold.typedInput('hide');
                                    $row2.hide();
                                } else if (propType === 'jsonata') {
                                    $dialogCondOperator.show();
                                    $dialogCondOperator.attr('disabled', true);
                                    $dialogCondOperator.val(selFields.comparator[0].id); // only true is valid for jsonata
                                    $dialogCondThreshold.typedInput('hide');
                                    $row2.show();
                                } else {
                                    $dialogCondOperator.show();
                                    $dialogCondOperator.attr('disabled', false);
                                    if (getOperandCount(selFields, $dialogCondOperator.val()) > 1) {
                                        $dialogCondThreshold.typedInput('show');
                                    } else {
                                        $dialogCondThreshold.typedInput('hide');
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        if (propType === types.SunAzimuth.value || types.SunElevation.value) { d.value = d.value.toFixed(3); }
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'operand'], d.value);
                                        $dialogCondOperand.attr('title', d.value);
                                        $row1.attr('title', d.value);
                                    } else {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'operand'], '');
                                        $dialogCondOperand.attr('title', '');
                                        $row1.attr('title', '');
                                    }
                                    _dialogGenHelpText();
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           propType,
                                    value:          $dialogCondOperand.typedInput('value'),
                                    noOffsetError:  true
                                });
                                $dialogCondLogOperator.change();
                                resizeConditionContainer();
                            });
                            if (containerIndex === 0) {
                                $dialogCondLogOperator.hide();
                            } else {
                                $dialogCondLogOperator.show();
                            }
                            $dialogCondOperator.change(() => {
                                $dialogCondOperand.change();
                            });
                            $dialogCondThreshold.change(() => {
                                const propType = $dialogCondOperand.typedInput('type');
                                const thresholdValueType = $dialogCondThreshold.typedInput('type');
                                if (propType === types.SunAzimuth.value) {
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $dialogCondThreshold.typedInput('type', types.numAzimuth.value);
                                    }
                                } else if (propType === types.SunElevation.value) {
                                    if (thresholdValueType.indexOf('num') >=0) {
                                        $dialogCondThreshold.typedInput('type', types.numAltitude.value);
                                    }
                                }
                                getBackendData(d => {
                                    if (d.value && d.value !== 'none' && d.useful) {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'threshold'], d.value);
                                        $dialogCondThreshold.attr('title', d.value);
                                        $row2.attr('title', d.value);
                                    } else {
                                        addProps(node.dialogAddData, ['cond', containerIndex, 'threshold'], '');
                                        $dialogCondThreshold.attr('title', '');
                                        $row2.attr('title', '');
                                    }
                                    _dialogGenHelpText();
                                }, {
                                    nodeId:         node.id,
                                    kind:           'getOutDataData',
                                    config:         $nodeConfig.val(),
                                    type:           thresholdValueType,
                                    value:          $dialogCondThreshold.typedInput('value'),
                                    noOffsetError:  true
                                });
                            });
                            $dialogCondOperand.change();
                            resizeConditionContainer();
                            _dialogGenHelpText();
                        },
                        sortItems(rules) {
                            rules.each(function (i) {
                                const $rule = $(this);
                                $rule.find('.dlg-ip-btctl-rule-condIndex').val(i + 1);
                                if (i === 0) {
                                    $rule.find('.dlg-ip-btctl-rule-condLogOperator').hide();
                                } else {
                                    $rule.find('.dlg-ip-btctl-rule-condLogOperator').show();
                                }
                            });
                            _dialogGenHelpText();
                        },
                        // resizeItem: resizeRule,
                        sortable: true,
                        removable: true,
                        removeItem() {
                            resizeConditionContainer();
                            _dialogGenHelpText();
                        }
                    }); // condition-container
                    $dialog.find('#dlg-ip-btctl-rule-condition-text').html(node._('node-red-contrib-sun-position/position-config:ruleCtrl.text.ruleCondition'));
                    // #endregion dialogConditions
                    // #region dialogTimeReg
                    const $dialogTimeRegOperator = $dialog.find('#dlg-ip-btctl-rule-timeReg-operator');
                    $dialogTimeRegOperator.append($('<option></option>').val(cNBC_RULE_TYPE_UNTIL).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeUntil')));
                    $dialogTimeRegOperator.append($('<option></option>').val(cNBC_RULE_TYPE_FROM).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeFrom')));

                    const $dialogTimeRegInput = $dialog.find('#dlg-ip-btctl-rule-timeReg');
                    $dialogTimeRegInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByAzimuthRad
                        ]
                    });
                    $dialogTimeRegInput.typedInput('width', '40%');

                    const $dialogTimeRegMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeReg');
                    appendOptions(node, $dialogTimeRegMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeRegOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeReg');
                    $dialogTimeRegOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeRegOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeRegMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeRegMultiplier.prop('disabled', false);
                        }
                        $dialogTimeRegInput.change();
                    });
                    $dialogTimeRegOffset.typedInput('width', '40%');
                    // #endregion dialogTimeReg
                    // #region dialogTimeMin
                    const $dialogTimeMinInput = $dialog.find('#dlg-ip-btctl-rule-timeMin');
                    $dialogTimeMinInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByAzimuthRad
                        ]
                    });
                    $dialogTimeMinInput.typedInput('width', '40%');

                    const $dialogTimeMinMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeMin');
                    appendOptions(node, $dialogTimeMinMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeMinOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeMin');
                    $dialogTimeMinOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeMinOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeMinMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeMinMultiplier.prop('disabled', false);
                        }
                        $dialogTimeMinInput.change();
                    });
                    $dialogTimeMinOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMin
                    // #region dialogTimeMax
                    const $dialogTimeMaxInput = $dialog.find('#dlg-ip-btctl-rule-timeMax');
                    $dialogTimeMaxInput.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            types.TimeEntered,
                            types.TimeSun,
                            types.TimeMoon,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.SunTimeByAzimuth,
                            types.SunTimeByAzimuthRad
                        ]
                    });
                    $dialogTimeMaxInput.typedInput('width', '40%');

                    const $dialogTimeMaxMultiplier = $dialog.find('#dlg-ip-btctl-rule-multiplier-timeMax');
                    appendOptions(node, $dialogTimeMaxMultiplier, 'multiplier', data => (data.id > 0));

                    const $dialogTimeMaxOffset = $dialog.find('#dlg-ip-btctl-rule-offset-timeMax');
                    $dialogTimeMaxOffset.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'num',
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => {
                        const type = $dialogTimeMaxOffset.typedInput('type');
                        if (type === types.Undefined.value) {
                            $dialogTimeMaxMultiplier.prop('disabled', true);
                        } else {
                            $dialogTimeMaxMultiplier.prop('disabled', false);
                        }
                        $dialogTimeMaxInput.change();
                    });
                    $dialogTimeMaxOffset.typedInput('width', '40%');
                    // #endregion dialogTimeMax
                    // #region dialogTimeLimit
                    $dialog.find('#dialog-row-timeConstraints-show').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').hide();
                        $dialog.find('#dialog-row-timeConstraints').fadeIn('slow');
                    });

                    $dialog.find('#dialog-row-timeConstraints-hide').click(() => {
                        $dialog.find('#dialog-row-timeConstraintsPlaceholder').fadeIn('slow');
                        $dialog.find('#dialog-row-timeConstraints').hide();
                    });

                    const $dialogTimeLimitOnlyEvenDays = $dialog.find('#dlg-ip-btctl-rule-timeOnlyEvenDays');
                    const $dialogTimeLimitOnlyOddDays = $dialog.find('#dlg-ip-btctl-rule-timeOnlyOddDays');
                    const $dialogTimeLimitOnlyEvenWeeks = $dialog.find('#dlg-ip-btctl-rule-timeOnlyEvenWeeks');
                    const $dialogTimeLimitOnlyOddWeeks = $dialog.find('#dlg-ip-btctl-rule-timeOnlyOddWeeks');
                    const $dialogTimeLimitDateStart = $dialog.find('#dlg-ip-btctl-rule-timedatelimit-start');
                    const $dialogTimeLimitDateEnd = $dialog.find('#dlg-ip-btctl-rule-timedatelimit-end');
                    $dialogTimeLimitDateStart.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateEnd.attr('min', year + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '01-01'));
                        $dialogTimeLimitDateEnd.attr('max', (year + 1) + '-' + (getDateShort($dialogTimeLimitDateStart.val()) || '12-31'));
                        _dialogGenHelpText();
                    });
                    $dialogTimeLimitDateEnd.change(() => {
                        const year = (new Date()).getFullYear();
                        $dialogTimeLimitDateStart.attr('min', year + '-01-01');
                        $dialogTimeLimitDateStart.attr('max', $dialogTimeLimitDateEnd.val() || (year + '-12-31'));
                        _dialogGenHelpText();
                    });
                    // #endregion dialogTimeLimit
                    // #region overwrite + importance
                    const $dialogImportance = $dialog.find('#dlg-ip-btctl-rule-importance');
                    $dialogImportance.spinner({
                        max: 1000,
                        min: 0,
                        step: 1,
                        stop:(_e, _ui) => { _dialogGenHelpText(); }
                    });
                    $dialogImportance.change(() => { $dialogLevelOperator.change(); });
                    const $dialogResetOverwrite = $dialog.find('#dlg-ip-btctl-rule-resetOverwrite');
                    $dialogResetOverwrite.change(() => {  $dialogLevelOperator.change(); });
                    // #endregion overwrite + importance
                    // #region dialogLevel
                    const $dialogLevel = $dialog.find('#dlg-ip-btctl-rule-level');
                    $dialogLevel.typedInput({
                        default: types.LevelFix.value,
                        types: [
                            types.LevelFix,
                            types.LevelEntered,
                            types.LevelND,
                            'msg',
                            'flow',
                            'global',
                            'env',
                            'jsonata'
                        ]
                    }).change(() => { $dialogLevelOperator.change(); });
                    $dialogLevel.typedInput('width', '40%');
                    const $dialogLevelOperator = $dialog.find('#dlg-ip-btctl-rule-level-operator');
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.levelAbsolute      ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelAbs')));
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.levelMinOversteer  ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelMin')));
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.levelMaxOversteer  ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelMax')));
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.slatOversteer      ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleSlatOversteer')));
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.topicOversteer     ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTopicOversteer')));
                    $dialogLevelOperator.append($('<option></option>').val(cNBC_RULE_OP.off                ).text(node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleOff')));
                    $dialogLevelOperator.change(() => {
                        const type =  $dialogLevel.typedInput('type');
                        if (type === types.LevelND.value) {
                            $dialogLevel.typedInput('show');
                            $dialogLevelOperator.hide();
                            $('#dialog-row-slatPos').show();
                            $('#dialog-row-topic').show();
                            $('#dialog-hr-overwrite').show();
                            $('#dialog-row-resetOverwrite').show();
                            $('#dialog-row-importance').show();
                        } else if (parseInt($dialogLevelOperator.val()) <= 0) { // ruleLevelAbs
                            $dialogLevel.typedInput('show');
                            $dialogLevelOperator.show();
                            $('#dialog-row-slatPos').show();
                            $('#dialog-row-topic').show();
                            $('#dialog-hr-overwrite').show();
                            $('#dialog-row-resetOverwrite').show();
                            $('#dialog-row-importance').show();
                        } else if (parseInt($dialogLevelOperator.val()) === 5) { // ruleSlatOversteer
                            $dialogLevel.typedInput('hide');
                            $dialogLevelOperator.show();
                            $('#dialog-row-slatPos').show();
                            $('#dialog-row-topic').hide();
                            $('#dialog-hr-overwrite').show();
                            $('#dialog-row-resetOverwrite').hide();
                            // $dialogResetOverwrite.prop('checked', false);
                            $('#dialog-row-importance').show();
                        } else if (parseInt($dialogLevelOperator.val()) === 8) { // ruleTopicOversteer
                            $dialogLevel.typedInput('hide');
                            $dialogLevelOperator.show();
                            $('#dialog-row-slatPos').hide();
                            $('#dialog-row-topic').show();
                            $('#dialog-hr-overwrite').show();
                            $('#dialog-row-resetOverwrite').hide();
                            // $dialogResetOverwrite.prop('checked', false);
                            $('#dialog-row-importance').show();
                        } else if (parseInt($dialogLevelOperator.val()) === 9) { // ruleOff
                            $dialogLevel.typedInput('hide');
                            $dialogLevelOperator.show();
                            $('#dialog-row-slatPos').hide();
                            $('#dialog-row-topic').hide();
                            $('#dialog-hr-overwrite').hide();
                            $('#dialog-row-resetOverwrite').hide();
                            // $dialogResetOverwrite.prop('checked', false);
                            $('#dialog-row-importance').hide();
                            // $dialogImportance.val(0);
                        } else { // ruleLevelMin or ruleLevelMax
                            $dialogLevel.typedInput('show');
                            $dialogLevelOperator.show();
                            $('#dialog-row-slatPos').hide();
                            $('#dialog-row-topic').hide();
                            $('#dialog-hr-overwrite').hide();
                            $('#dialog-row-resetOverwrite').hide();
                            $dialogResetOverwrite.prop('checked', false);
                            $('#dialog-row-importance').hide();
                            // $dialogImportance.val(0);
                        }
                        _dialogGenHelpText();
                    });
                    // #endregion dialogLevel
                    // #region dialogSlat
                    const $dialogSlat = $dialog.find('#dlg-ip-btctl-rule-slatPos');
                    $dialogSlat.typedInput({
                        default: types.Undefined.value,
                        types: [
                            types.Undefined,
                            'str',
                            'num',
                            'bool',
                            types.MsgPayload,
                            types.MsgValue,
                            'msg',
                            'flow',
                            'global',
                            'json',
                            'bin',
                            'env',
                            'jsonata',
                            types.randmNumCachedDay,
                            types.randmNumCachedWeek
                        ]
                    }).change(() => { _dialogGenHelpText(); });
                    $dialogSlat.typedInput('width', '50%');
                    // #endregion dialogSlat
                    // #region topic
                    const $dialogTopic = $dialog.find('#dlg-ip-btctl-rule-topic');
                    $dialogTopic.change(() => { _dialogGenHelpText(); });
                    // #endregion topic
                    // #region dialogChange
                    $dialogTimeRegInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opType = $dialogTimeRegInput.typedInput('type');
                        if (opType === types.Undefined.value) {
                            node.dialogAddData.timeReg = {
                                ts : 0,
                                data : null,
                                text : 'N/A'
                            };
                            $('#dialog-row-timeReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            $dialogTimeRegOperator.hide();
                            $('#dialog-row-offset-timeReg').hide();
                            $('#dialog-row-timeReg').attr('title', opType);

                            $('#dialog-row-timeMin').hide();
                            $('#dialog-row-timeMax').hide();
                            $('#dialog-row-offset-timeMin').hide();
                            $('#dialog-row-offset-timeMax').hide();
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').hide();
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            if ($dialogTimeMaxInput.typedInput('type') !== types.Undefined.value) {
                                $dialogTimeMaxInput.typedInput('type', types.Undefined.value);
                            }
                            _dialogGenHelpText();
                            return;
                        }
                        $dialogTimeRegOperator.show();
                        if (opType === types.TimeEntered.value ||
                           opType === types.TimeSun.value ||
                           opType === types.TimeMoon.value) {
                            $('#dialog-row-offset-timeReg').show();
                        } else {
                            $('#dialog-row-offset-timeReg').hide();
                        }

                        const noLimit = getCheckboxesStr($('#dlg-ip-btctl-rule-timeDays input[type=checkbox]:checked'), 7) === '*' &&
                                        getCheckboxesStr($('#dlg-ip-btctl-rule-timeMonths input[type=checkbox]:checked'), 12) === '*' &&
                                        $dialogTimeLimitOnlyEvenDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddDays.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyEvenWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitOnlyOddWeeks.is(':checked') !== true &&
                                        $dialogTimeLimitDateStart.val() === '' &&
                                        $dialogTimeLimitDateEnd.val() === '';
                        if (noLimit) {
                            $('.dialog-row-timeLimits').hide();
                            $('.dialog-row-timeLimits-ph').show();
                        } else {
                            $('.dialog-row-timeLimits').show();
                            $('.dialog-row-timeLimits-ph').hide();
                        }
                        getBackendData(d => {
                            if (d.value && d.value !== 'none') {
                                const dv = new Date(d.value);
                                node.dialogAddData.timeReg = {
                                    ts : dv.getTime(),
                                    data : d,
                                    text : bdDateToTime(dv)
                                };
                            } else {
                                node.dialogAddData.timeReg = {
                                    ts : 0,
                                    data : null,
                                    text : bdDateToTime(d)
                                };
                            }
                            $('#dialog-row-timeReg').attr('title', node.dialogAddData.timeReg.text);
                            $dialogTimeRegInput.attr('timedata', node.dialogAddData.timeReg.ts);
                            _dialogGenHelpText();
                        }, {
                            nodeId:         node.id,
                            kind:           'getTimeData',
                            config:         $nodeConfig.val(),
                            type:           opType,
                            value:          $dialogTimeRegInput.typedInput('value'),
                            offsetType:     $dialogTimeRegOffset.typedInput('type'),
                            offset:         $dialogTimeRegOffset.typedInput('value'),
                            multiplier:     parseInt($dialogTimeRegMultiplier.val()),
                            noOffsetError:  true
                        });
                        $dialogTimeMinInput.change();
                        $dialogTimeMaxInput.change();
                    });

                    $dialogTimeMinInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMin').show();
                            const opType = $dialogTimeMinInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMin').hide();
                                node.dialogAddData.timeMin = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMin').attr('title', node.dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', node.dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMin').show();
                            } else {
                                $('#dialog-row-offset-timeMin').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.timeMin = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.timeMin = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeMin').attr('title', node.dialogAddData.timeMin.text);
                                $dialogTimeMinInput.attr('timedata', node.dialogAddData.timeMin.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeMinInput.typedInput('value'),
                                offsetType:     $dialogTimeMinOffset.typedInput('type'),
                                offset:         $dialogTimeMinOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeMinMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });

                    $dialogTimeMaxInput.change(() => {
                        if (dialogDataOnLoading) { return; }
                        const opAType = $dialogTimeRegInput.typedInput('type');
                        if (opAType && opAType !== types.Undefined.value) {
                            $('#dialog-row-timeMax').show();
                            const opType = $dialogTimeMaxInput.typedInput('type');
                            if (opType === types.Undefined.value) {
                                $('#dialog-row-offset-timeMax').hide();
                                node.dialogAddData.timeMax = {
                                    ts : 0,
                                    data : null,
                                    text : 'N/A'
                                };
                                $('#dialog-row-timeMax').attr('title', node.dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', node.dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                                return;
                            } else if (opType === types.TimeEntered.value ||
                                       opType === types.TimeSun.value ||
                                       opType === types.TimeMoon.value) {
                                $('#dialog-row-offset-timeMax').show();
                            } else {
                                $('#dialog-row-offset-timeMax').hide();
                            }
                            getBackendData(d => {
                                if (d.value && d.value !== 'none') {
                                    const dv = new Date(d.value);
                                    node.dialogAddData.timeMax = {
                                        ts : dv.getTime(),
                                        data : d,
                                        text : bdDateToTime(dv)
                                    };
                                } else {
                                    node.dialogAddData.timeMax = {
                                        ts : 0,
                                        data : null,
                                        text : bdDateToTime(d)
                                    };
                                }
                                $('#dialog-row-timeMax').attr('title', node.dialogAddData.timeMax.text);
                                $dialogTimeMaxInput.attr('timedata', node.dialogAddData.timeMax.ts);
                                _dialogGenHelpText();
                            }, {
                                nodeId:         node.id,
                                kind:           'getTimeData',
                                config:         $nodeConfig.val(),
                                type:           opType,
                                value:          $dialogTimeMaxInput.typedInput('value'),
                                offsetType:     $dialogTimeMaxOffset.typedInput('type'),
                                offset:         $dialogTimeMaxOffset.typedInput('value'),
                                multiplier:     parseInt($dialogTimeMaxMultiplier.val()),
                                noOffsetError:  true
                            });
                        }
                        _dialogGenHelpText();
                    });
                    $('.dialog-row-timeLimits :input').change(() => {
                        if (node.dialogAddData.timeout2) { clearTimeout(node.dialogAddData.timeout2); }
                        node.dialogAddData.timeout2 = setTimeout(() => {
                            delete node.dialogAddData.timeout2;
                            $dialogTimeRegInput.change();
                        },1000);
                    });
                    // #endregion dialogChange
                    // #region dialogload & save
                    /** generates the help text of the dialog */
                    function _dialogGenHelpText() {
                        $('#dlg-txt-btctl-rule-descr').html('');
                        if (node.dialogAddData.timeout) { clearTimeout(node.dialogAddData.timeout); }
                        node.dialogAddData.timeout = setTimeout(() => {
                            delete node.dialogAddData.timeout;
                            try {
                                $('#dlg-txt-btctl-rule-descr').html(getRuleDescription(node, selFields, _dialogGetData(), node.dialogAddData));
                            } catch (err) {
                                console.warn('_dialogGenHelpText - maybe too fast:', err.message); // eslint-disable-line no-console
                            }
                        },1000);
                    }
                    /** load the data from the rule */
                    function _dialogLoadData(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            $dialogName.val(data.name);
                            $dialogRuleEnableBtn.attr('is_enabled', data.enabled);
                            $dialogRuleEnableBtn.trigger('setRuleEnabledState');
                            dialogDataOnLoading = true;
                            $dialogConditionContainer.editableList('empty');
                            for (let i = 0; i < data.conditions.length; i++) {
                                $dialogConditionContainer.editableList('addItem', data.conditions[i]);
                            }
                            if (data.time) {
                                $dialogTimeRegOperator.val(data.time.operator);
                                $dialogTimeRegMultiplier.val(data.time.multiplier);
                                setTInputValue($dialogTimeRegInput, data.time.value, data.time.type);
                                setTInputValue($dialogTimeRegOffset, data.time.offset, data.time.offsetType);
                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeDays', data.time.days);
                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeMonths', data.time.months);
                                if (!!data.time.onlyEvenDays && !!data.time.onlyOddDays) {
                                    data.time.onlyEvenDays = false;
                                    data.time.onlyOddDays = false;
                                }
                                if (!!data.time.onlyEvenWeeks && !!data.time.onlyOddWeeks) {
                                    data.time.onlyEvenWeeks = false;
                                    data.time.onlyOddWeeks = false;
                                }
                                $dialogTimeLimitOnlyEvenDays.prop('checked', !!data.time.onlyEvenDays);
                                $dialogTimeLimitOnlyOddDays.prop('checked', !!data.time.onlyOddDays);
                                $dialogTimeLimitOnlyEvenWeeks.prop('checked', !!data.time.onlyEvenWeeks);
                                $dialogTimeLimitOnlyOddWeeks.prop('checked', !!data.time.onlyOddWeeks);
                                const year = (new Date()).getFullYear();
                                let dStart, dEnd;
                                if (data.time.dateStart) {
                                    dStart = new Date(data.time.dateStart);
                                    dStart.setHours(0, 0, 0, 1);
                                    dStart.setFullYear(year);
                                } else {
                                    dStart = new Date(year, 0, 1, 0, 0, 0, 1);
                                }

                                if (data.time.dateEnd) {
                                    dEnd = new Date(data.time.dateEnd);
                                    dEnd.setHours(23, 59, 59, 999);
                                    dEnd.setFullYear(year);
                                } else {
                                    dEnd = new Date(year, 11, 31, 23, 59, 59, 999);
                                }

                                if (dEnd.getTime() < dStart.getTime()) {
                                    dEnd.setFullYear(year + 1);
                                }
                                const pad = (n, z = 2) => ('00' + n).slice(-z);
                                if (data.time.dateStart) {
                                    $dialogTimeLimitDateStart.val(dStart.getFullYear() + '-' + pad(dStart.getMonth() + 1) + '-' + pad(dStart.getDate()));
                                }
                                if (data.time.dateEnd) {
                                    $dialogTimeLimitDateEnd.val(dEnd.getFullYear() + '-' + pad(dEnd.getMonth() + 1) + '-' + pad(dEnd.getDate()));
                                }
                                $dialogTimeLimitDateStart.change();
                                $dialogTimeLimitDateEnd.change();
                            } else {
                                $dialogTimeRegOperator.val(0);
                                $dialogTimeRegMultiplier.val(60000);
                                setTInputValue($dialogTimeRegInput, '', types.Undefined.value);
                                setTInputValue($dialogTimeRegOffset, 1, types.Undefined.value);
                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeDays', '*');
                                initCheckboxesBlock('#dlg-ip-btctl-rule-timeMonths', '*');
                                $dialogTimeLimitOnlyEvenDays.prop('checked', false);
                                $dialogTimeLimitOnlyOddDays.prop('checked', false);
                                $dialogTimeLimitOnlyEvenWeeks.prop('checked', false);
                                $dialogTimeLimitOnlyOddWeeks.prop('checked', false);
                                $dialogTimeLimitDateStart.val('');
                                $dialogTimeLimitDateEnd.val('');
                            }
                            if (data.timeMin) {
                                $dialogTimeMinMultiplier.val(data.timeMin.multiplier || 60000);
                                setTInputValue($dialogTimeMinInput, data.timeMin.value, data.timeMin.type);
                                setTInputValue($dialogTimeMinOffset, data.timeMin.offset, data.timeMin.offsetType);
                            } else {
                                setTInputValue($dialogTimeMinInput, '', types.Undefined.value);
                                setTInputValue($dialogTimeMinOffset, 1, types.Undefined.value);
                                $dialogTimeMinMultiplier.val(60000);
                            }
                            if (data.timeMax) {
                                $dialogTimeMaxMultiplier.val(data.timeMax.multiplier || 60000);
                                setTInputValue($dialogTimeMaxInput, data.timeMax.value, data.timeMax.type);
                                setTInputValue($dialogTimeMaxOffset, data.timeMax.offset, data.timeMax.offsetType);
                            } else {
                                setTInputValue($dialogTimeMaxInput, '', types.Undefined.value);
                                setTInputValue($dialogTimeMaxOffset, 1, types.Undefined.value);
                                $dialogTimeMaxMultiplier.val(60000);
                            }
                            if (data.level) {
                                $dialogLevelOperator.val(data.level.operator || 0);
                                setTInputValue($dialogLevel, data.level.value, data.level.type);
                            } else {
                                $dialogLevelOperator.val(0);
                                setTInputValue($dialogLevel, 'closed (min)', types.LevelFix.value);
                            }
                            if (data.slat) {
                                setTInputValue($dialogSlat, data.slat.value, data.slat.type);
                            } else {
                                setTInputValue($dialogSlat, '', types.Undefined.value);
                            }
                            $dialogTopic.val(data.topic || '');
                            $dialogImportance.val(data.importance || 0);
                            $dialogResetOverwrite.prop('checked', (!!data.resetOverwrite));

                            _dialogGenHelpText();
                            dialogDataOnLoading = false;
                            $dialogTimeRegInput.change();
                            $dialogLevelOperator.change();
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            $dialogName.val(err.message);
                        }
                        $dialog.dialog('open');
                    }

                    /**
                     * Get the data object for a rule
                     */
                    function _dialogGetData() {
                        const result = {
                            index: dialogDataIndex,
                            name:$dialogName.val(),
                            version: ruleVersion,
                            enabled: !($dialogRuleEnableBtn.attr('is_enabled') === false || $dialogRuleEnableBtn.attr('is_enabled') === 'false'),
                            isValid: true,
                            valid:{
                                conditions : []
                            },
                            conditions: [],
                            level: {
                                type        : $dialogLevel.typedInput('type'),
                                value       : $dialogLevel.typedInput('value'),
                                operator    : parseInt($dialogLevelOperator.val()),
                                operatorText: $dialogLevelOperator.find('option:selected').text()
                            },
                            slat: {
                                type        : $dialogSlat.typedInput('type'),
                                value       : $dialogSlat.typedInput('value')
                            },
                            topic: $dialogTopic.val() || '',
                            resetOverwrite: $dialogResetOverwrite.is(':checked'),
                            importance: parseInt($dialogImportance.val())
                        };
                        try {
                            const setval = (param, name, val) => { if (val) param[name] = val; };
                            if (result.level.type === types.LevelND.value) {
                                result.level.operator = 0;
                                result.level.operatorText = node._('node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleLevelAbs');
                            } else if (result.level.operator === cNBC_RULE_OP.levelMinOversteer || result.level.operator === cNBC_RULE_OP.levelMaxOversteer ) {
                                delete result.slat;
                                delete result.topic;
                                delete result.resetOverwrite;
                                delete result.importance;
                            } else if (result.level.operator === cNBC_RULE_OP.slatOversteer) {
                                delete result.level.type;
                                delete result.level.value;
                                delete result.topic;
                                delete result.resetOverwrite;
                            } else if (result.level.operator === cNBC_RULE_OP.topicOversteer) {
                                delete result.level.type;
                                delete result.level.value;
                                delete result.slat;
                                delete result.resetOverwrite;
                            } else if (result.level.operator === cNBC_RULE_OP.off) {
                                delete result.level.type;
                                delete result.level.value;
                                delete result.slat;
                                delete result.topic;
                                delete result.resetOverwrite;
                                delete result.importance;
                            }

                            $dialogConditionContainer.editableList('items').each(function(_i) {
                                const $cond = $(this);
                                const p = {
                                    condition       : Number($cond.find('.dlg-ip-btctl-rule-condLogOperator').val()),
                                    conditionText   : $cond.find('.dlg-ip-btctl-rule-condLogOperator option:selected').text(),
                                    valueType       : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('type'),
                                    value           : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('value'),
                                    operator        : $cond.find('.dlg-ip-btctl-rule-condOperator').val(),
                                    operatorText    : $cond.find('.dlg-ip-btctl-rule-condOperator option:selected').text(),
                                    thresholdType   : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('type'),
                                    threshold       : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('value')
                                };
                                if (p.thresholdType === 'num' && p.threshold === '') {
                                    p.threshold = 0;
                                }
                                if (_i === 0) {
                                    delete p.condition;
                                    delete p.conditionText;
                                }
                                result.conditions.push(p);
                                const isCValid = {
                                    index       : _i,
                                    value       : $cond.find('.dlg-ip-btctl-rule-condOperand').typedInput('validate'),
                                    threshold   : $cond.find('.dlg-ip-btctl-rule-condThreshold').typedInput('validate')
                                };
                                result.valid.conditions.push(isCValid);
                                result.isValid = result.isValid && isCValid.value && isCValid.threshold;
                            });
                            const timeType = $dialogTimeRegInput.typedInput('type');
                            result.valid.time = $dialogTimeRegInput.typedInput('validate');
                            if (timeType !== 'none') {
                                result.time = {
                                    type            : timeType,
                                    value           : $dialogTimeRegInput.typedInput('value'),
                                    operator        : parseInt($dialogTimeRegOperator.val()),
                                    operatorText    : $dialogTimeRegOperator.find('option:selected').text(),
                                    offsetType      : $dialogTimeRegOffset.typedInput('type'),
                                    offset          : $dialogTimeRegOffset.typedInput('value'),
                                    multiplier      : parseInt($dialogTimeRegMultiplier.val()),
                                    days            : getCheckboxesStr($('#dlg-ip-btctl-rule-timeDays input[type=checkbox]:checked'),7),
                                    months          : getCheckboxesStr($('#dlg-ip-btctl-rule-timeMonths input[type=checkbox]:checked'), 12)
                                };
                                setval(result.time,'onlyEvenDays', $dialogTimeLimitOnlyEvenDays.is(':checked'));
                                setval(result.time,'onlyOddDays', $dialogTimeLimitOnlyOddDays.is(':checked'));
                                setval(result.time,'onlyEvenWeeks', $dialogTimeLimitOnlyEvenWeeks.is(':checked'));
                                setval(result.time,'onlyOddWeeks', $dialogTimeLimitOnlyOddWeeks.is(':checked'));
                                setval(result.time,'dateStart', $dialogTimeLimitDateStart.val());
                                setval(result.time,'dateEnd', $dialogTimeLimitDateEnd.val());

                                result.valid.time = result.valid.time && $dialogTimeRegOffset.typedInput('validate') && result.time.multiplier;
                                if (result.time.onlyEvenDays && result.time.onlyOddDays) {
                                    delete result.time.onlyEvenDays;
                                    delete result.time.onlyOddDays;
                                }
                                if (result.time.onlyEvenWeeks && result.time.onlyOddWeeks) {
                                    delete result.time.onlyEvenWeeks;
                                    delete result.time.onlyOddWeeks;
                                }
                                if (!result.time.days || !result.time.months) {
                                    result.valid.time = false;
                                }
                                const minType = $dialogTimeMinInput.typedInput('type');
                                result.valid.timeMin = $dialogTimeMinInput.typedInput('validate');
                                if (minType !== 'none') {
                                    result.timeMin = {
                                        type        : minType,
                                        value       : $dialogTimeMinInput.typedInput('value'),
                                        offsetType  : $dialogTimeMinOffset.typedInput('type'),
                                        offset      : $dialogTimeMinOffset.typedInput('value'),
                                        multiplier  : parseInt($dialogTimeMinMultiplier.val())
                                    };
                                    result.valid.timeMin = result.valid.timeMin &&
                                        $dialogTimeMinOffset.typedInput('validate') &&
                                        result.timeMin.multiplier;
                                }
                                const maxType = $dialogTimeMaxInput.typedInput('type');
                                result.valid.timeMax = $dialogTimeMaxInput.typedInput('validate');
                                if (maxType !== 'none') {
                                    result.timeMax = {
                                        type        : maxType,
                                        value       : $dialogTimeMaxInput.typedInput('value'),
                                        offsetType  : $dialogTimeMaxOffset.typedInput('type'),
                                        offset      : $dialogTimeMaxOffset.typedInput('value'),
                                        multiplier  :  parseInt($dialogTimeMaxMultiplier.val())
                                    };
                                    result.valid.timeMax =result.valid.timeMax &&
                                        result.timeMax.multiplier;
                                }
                                result.isValid = result.isValid && result.valid.time && result.valid.timeMin && result.valid.timeMax;
                            }
                            result.valid.level = (result.level.operator === cNBC_RULE_OP.off) ||
                                                 (result.level.operator === cNBC_RULE_OP.slatOversteer) ||
                                                 (result.level.operator === cNBC_RULE_OP.topicOversteer) ||
                                                 $dialogLevel.typedInput('validate');
                            result.valid.slat = (result.level.operator === cNBC_RULE_OP.off) ||
                                                (result.level.operator === cNBC_RULE_OP.topicOversteer) ||
                                                (result.level.operator === cNBC_RULE_OP.levelMaxOversteer) ||
                                                (result.level.operator === cNBC_RULE_OP.levelMinOversteer) ||
                                                $dialogSlat.typedInput('validate');
                            result.isValid = result.isValid && result.valid.level && result.valid.slat;
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            result.isValid = false;
                            result.valid.error = err.message;
                        }
                        if (!result.isValid) {
                            console.log('rule validation:',result.isValid, result.valid); // eslint-disable-line
                        } else {
                            delete result.valid; // if valid, not needed
                        }
                        return result;
                    }
                    /**
                     * save the data of the rule back
                     */
                    function _dialogSaveData() {
                        const data = _dialogGetData();
                        data.description = getRuleDescription(node, selFields, data);
                        $dialogDataRow.data('ruleData', JSON.stringify(data));
                        $('#rule-name-'+dialogDataIndex).text((data.name || 'rule ' + (dialogDataIndex + 1)) + ((data.importance > 0) ? ' ['+data.importance+']' : ''));
                        $('#rule-description-'+dialogDataIndex).html(data.description);
                        $('#rule-btn-state-'+dialogDataIndex).trigger('setRuleEnabledState');
                        resizeRuleContainerCheck(node);
                    }

                    /**
                     * Duplicates an existing rule
                     */
                    function _dialogDuplicateRule(containerIndex, $containerRow) {
                        try {
                            $dialogDataRow = $containerRow;
                            dialogDataIndex = containerIndex;
                            const data = JSON.parse($dialogDataRow.data('ruleData'));
                            const nm = parseInt(data.name.match(/[0-9]+(?!.*[0-9])/), 10);
                            if (nm) {
                                data.name = data.name.replace(/[0-9]+(?!.*[0-9])/, nm + 1);
                            } else {
                                data.name += ' - copy 1';
                            }
                            data.description = getRuleDescription(node, selFields, data);
                            $('#node-input-rule-container').editableList('addItem', data);
                        } catch (err) {
                            console.log(err.message); // eslint-disable-line no-console
                            console.log(err.stack); // eslint-disable-line no-console
                            // $dialogName.val(err.message);
                        }
                        resizeRuleContainerCheck(node);
                    }
                    // #endregion dialogload & save
                    // #endregion dialog
                    resizeRuleContainerCheck(node);
                }; // setup

                $.getScript('sun-position/js/htmlglobal.js')
                    .done((_data, _textStatus,  _bmvfj) => {
                        try {
                            setup(node);
                        } catch (err) {
                            console.log("failed to setup editor"); // eslint-disable-line
                            console.log(err); // eslint-disable-line
                            console.log(err.stack); // eslint-disable-line
                        }

                        tabs.addTab({
                            id: 'blind-control-tab-general',
                            label: this._('blind-control.tabs-label.general'),
                            name: this._('blind-control.tabs-label.general'),
                            iconClass: 'fa fa-tags'
                        });
                        $nodeConfig.change(() => {
                            if ($nodeConfig.val() === '_ADD_' || $nodeConfig.val() === '') {
                                if (tabs.count() > 1){
                                    tabs.removeTab('blind-control-tab-default');
                                    tabs.removeTab('blind-control-tab-time');
                                    tabs.removeTab('blind-control-tab-sun-control');
                                    tabs.removeTab('blind-control-tab-output');
                                }
                            } else if (tabs.count() <= 1) {
                                tabs.addTab({
                                    id: 'blind-control-tab-default',
                                    label: this._('blind-control.tabs-label.default'),
                                    name: this._('blind-control.tabs-label.default'),
                                    iconClass: 'fa fa-sliders'
                                    // icon
                                    // maximumTabWidth
                                    // pinned
                                    // action
                                    // closeable
                                });

                                tabs.addTab({
                                    id: 'blind-control-tab-time',
                                    label: this._('blind-control.tabs-label.time'),
                                    name: this._('blind-control.tabs-label.time'),
                                    iconClass: 'fa fa-clock-o'
                                });

                                tabs.addTab({
                                    id: 'blind-control-tab-sun-control',
                                    label: this._('blind-control.tabs-label.sun-control'),
                                    name: this._('blind-control.tabs-label.sun-control'),
                                    iconClass: 'fa fa-sun-o'
                                });

                                tabs.addTab({
                                    id: 'blind-control-tab-output',
                                    label: this._('blind-control.tabs-label.output'),
                                    name: this._('blind-control.tabs-label.output'),
                                    iconClass: 'fa fa-sign-out'
                                });
                            }
                            setTimeout(() => { tabs.resize(); }, 0);
                        });
                        $nodeConfig.change();
                    })
                    .fail((jqxhr, settings, exception) => {
                        console.log("failed to load htmlglobal.js"); // eslint-disable-line
                        console.log(exception); // eslint-disable-line
                        console.log(exception.stack); // eslint-disable-line
                    });
            },
            oneditsave() {
                const node = this;
                node.rules = [];
                $('#node-input-rule-container').editableList('items').each(function (_i) {
                    const $rule = $(this);
                    const data = JSON.parse($rule.data('ruleData'));
                    data.index= _i;
                    node.rules.push(data);
                });

                const overwriteExpire = parseFloat($('#blind-control-overwriteExpire').val());
                if (isNaN(overwriteExpire) || overwriteExpire === '' || overwriteExpire === 0) {
                    $('#node-input-overwriteExpire').val('');
                } else {
                    let val = overwriteExpire * parseFloat($('#blind-control-overwriteExpire-multiplier').val());
                    if (val < 1000) {
                        val = 1000;
                    }
                    $('#node-input-overwriteExpire').val(val);
                }

                const autoTriggerTime = parseFloat($('#blind-control-autoTriggerTime').val());
                if (isNaN(autoTriggerTime) || autoTriggerTime === '' || autoTriggerTime <= 0) {
                    $('#node-input-autoTriggerTime').val(20*60000);
                } else {
                    let val = autoTriggerTime * parseFloat($('#blind-control-autoTriggerTime-multiplier').val());
                    if (val < 60000) {
                        val = 60000;
                    }
                    $('#node-input-autoTriggerTime').val(val);
                }

                const startDelayTime = parseFloat($('#blind-control-startDelayTime').val());
                if (isNaN(startDelayTime) || startDelayTime === '' || startDelayTime <= 0) {
                    $('#node-input-startDelayTime').val(0);
                    $('#time-control-startDelayTime-multiplier').val(60000);
                } else {
                    let val = startDelayTime * parseFloat($('#blind-control-startDelayTime-multiplier').val());
                    if (val < 0) {
                        val = 0;
                    }
                    $('#node-input-startDelayTime').val(val);
                }

                const smoothTime = parseFloat($('#blind-control-smoothTime').val());
                if (isNaN(smoothTime) || smoothTime === '' || smoothTime === 0) {
                    $('#node-input-smoothTime').val('');
                } else {
                    $('#node-input-smoothTime').val(smoothTime * parseFloat($('#blind-control-smoothTime-multiplier').val()));
                }
                $('#dialog-edit-rule').dialog('destroy').remove();

                delete node.oversteerValue;
                delete node.oversteerValueType;
                delete node.oversteerCompare;
                delete node.oversteerThreshold;
                delete node.oversteerThresholdType;
                delete node.oversteerBlindPos;
                delete node.oversteerBlindPosType;
                delete node.oversteer2Value;
                delete node.oversteer2ValueType;
                delete node.oversteer2Compare;
                delete node.oversteer2Threshold;
                delete node.oversteer2ThresholdType;
                delete node.oversteer2BlindPos;
                delete node.oversteer2BlindPosType;
                delete node.oversteer3Value;
                delete node.oversteer3ValueType;
                delete node.oversteer3Compare;
                delete node.oversteer3Threshold;
                delete node.oversteer3ThresholdType;
                delete node.oversteer3BlindPos;
                delete node.oversteer3BlindPosType;
                delete node.sunMinAltitude;
                node.oversteers= [];
                $('#node-input-oversteer-container').editableList('items').each(function(_i) {
                    const $rule = $(this);
                    const p = {
                        mode            : parseInt($rule.find('.node-input-oversteer-mode').val()),
                        valueType       : $rule.find('.node-input-oversteer-value').typedInput('type'),
                        value           : $rule.find('.node-input-oversteer-value').typedInput('value'),
                        operator        : $rule.find('.node-input-oversteer-compare').val(),
                        operatorText    : $rule.find('.node-input-oversteer-compare option:selected').text(),
                        thresholdType   : $rule.find('.node-input-oversteer-threshold').typedInput('type'),
                        threshold       : $rule.find('.node-input-oversteer-threshold').typedInput('value'),
                        onlySunInWindow : $rule.find('.node-input-oversteer-sunInWindow').is(':checked'),
                        blindPos        : {
                            type        : $rule.find('.node-input-oversteer-blindPos').typedInput('type'),
                            value       : $rule.find('.node-input-oversteer-blindPos').typedInput('value')
                        },
                        slatPos         : {
                            type        : $rule.find('.node-input-oversteer-slatPos').typedInput('type'),
                            value       : $rule.find('.node-input-oversteer-slatPos').typedInput('value')
                        }
                    };
                    if (p.thresholdType === 'num' && p.threshold === '') {
                        p.threshold = 0;
                    }
                    node.oversteers.push(p);
                });

                const results = $('#node-input-result-container').editableList('items');
                node.results = [];
                results.each(function (_i) {
                    const prop = $(this);
                    const p = {
                        p: prop.find('.node-input-prop-result-name').typedInput('value'),
                        pt: prop.find('.node-input-prop-result-name').typedInput('type'),
                        v: prop.find('.node-input-prop-result-value').typedInput('value'),
                        vt: prop.find('.node-input-prop-result-value').typedInput('type')
                    };
                    p.f = (p.fS !== 99 ? p.fS : p.fI);
                    if (p.p === 'payload' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgPayload';
                    } else if (p.p === 'topic' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgTopic';
                    } else if (p.p === 'value' && (!p.pt || p.pt === 'msg')) {
                        p.pt = 'msgValue';
                    }
                    node.results.push(p);
                });
            },
            oneditcancel() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditdelete() {
                $('#dialog-edit-rule').dialog('destroy').remove();
            },
            oneditresize() {
                const height =  $('#node-config-blind-control-tabs-content').parent().innerHeight();
                $('#node-config-blind-control-tabs-content').height(height - 25);
            }
        });
    })();</script>

<script type="text/html" data-template-name="blind-control">
    <div class="form-row">
        <ul style="min-width: 400px; margin-bottom: 20px;" id="node-config-blind-control-tabs"></ul>
    </div>
    <div id="node-config-blind-control-tabs-content" style="min-height:150px;overflow-y: auto;overflow-x: hidden;">
        <div id="blind-control-tab-general" style="display:none">
            <div class="form-row block-noindent is-to-show-initially">
                <span><i class="fa fa-info-circle"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:common.label.infoText" class="row-full-width"></span></span>
            </div>
            <div class="form-row block-noindent" data-i18n="[title]node-red-contrib-sun-position/position-config:common.placeholder.positionConfig">
                <label for="node-input-positionConfig"><i class="fa fa-globe"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.positionConfig"></span></label>
                <input type="text" class="row-full-width" id="node-input-positionConfig">
            </div>
            <hr>
            <div class="form-row block-noindent" data-i18n="[title]node-red:common.label.name">
                <label for="node-input-name"><i class="icon-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
                <input type="text" id="node-input-name" class="row-full-width" data-i18n="[placeholder]node-red:common.label.name"/>
            </div>
            <div class="form-row block-noindent" data-i18n="[title]blind-control.label.addId">
                <label for="node-input-addId"><i class="icon-tag"></i> <span data-i18n="blind-control.label.addId"></span></label>
                <input type="text" id="node-input-addId" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.addId"/>
                <input type="hidden" id="node-input-addIdType"/>
            </div>
            <div class="form-tips is-to-show-initially">
                <span data-i18n="[html]blind-control.tips.documentation" style="word-wrap:break-word;"></span>
            </div>
        </div>
        <div id="blind-control-tab-default" style="display:none">
            <!-- blind ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span><i class="fa fa-window-maximize"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.blind" class="row-full-width"></span></span>
            </div>
            <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindIncrement">
                <label for="node-input-blindIncrement"><i class="fa fa-plus-circle"></i> <span data-i18n="blind-control.label.blindIncrement"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-blindIncrement" data-i18n="[placeholder]blind-control.placeholder.blindIncrement"/>
            </div>
            <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindOpenPos">
                <label for="node-input-blindOpenPos"><i class="fa fa-chevron-circle-up"></i> <span data-i18n="blind-control.label.blindOpenPos"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-blindOpenPos" data-i18n="[placeholder]blind-control.placeholder.blindOpenPos"/>
            </div>
            <div class="form-row block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindClosedPos">
                <label for="node-input-blindClosedPos"><i class="fa fa-chevron-circle-down"></i> <span data-i18n="blind-control.label.blindClosedPos"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-blindClosedPos" data-i18n="[placeholder]blind-control.placeholder.blindClosedPos"/>
            </div>
            <hr>
            <!-- default ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.blindLevelDefault" class="row-full-width"></span>
            </div>
            <div class="form-row block-noindent is-to-show-initially" data-i18n="[title]blind-control.placeholder.blindLevelDefault">
                <label for="node-input-blindPosDefault"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelDefault"></span></label>
                <input type="text" id="node-input-blindPosDefault" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelDefault"/>
                <input type="hidden" id="node-input-blindPosDefaultType"/>
            </div>
            <div class="form-row block-noindent is-to-show-initially" data-i18n="[title]blind-control.placeholder.slatPosDefault">
                <label for="node-input-slatPosDefault"><i class="fa fa-slack"></i> <span data-i18n="blind-control.label.slatPosDefault"></span></label>
                <input type="text" id="node-input-slatPosDefault" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.slatPosDefault"/>
                <input type="hidden" id="node-input-slatPosDefaultType"/>
            </div>
            <div class="form-row block-noindent time-topic" data-i18n="[title]node-red:common.label.topic">
                <label for="node-input-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
                <input type="text" id="node-input-topic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
            </div>
            <hr>
            <!-- overwrite ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span><i class="fa fa-hand-paper-o"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.overwriteBlind" class="row-full-width"></span></span>
            </div>
            <div class="form-row row-overwriteValue block-indent1" data-i18n="[titel]blind-control.placeholder.overwriteExpire">
                <label for="blind-control-overwriteExpire"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.overwriteExpire"></span></label>
                <input type="text" class="spinner-time" id="blind-control-overwriteExpire" data-i18n="[placeholder]blind-control.placeholder.overwriteExpire" value=""/>
                <select id="blind-control-overwriteExpire-multiplier" class="node-input-multiplier">
                    <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                    <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                    <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                    <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
                </select>
                <input type="hidden" id="node-input-overwriteExpire"/>
            </div>
        </div>
        <div id="blind-control-tab-time" style="display:none">
            <!-- time ######################################################################## -->
            <div class="is-to-show-initially">
                <span><i class="fa fa-list"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.time"></span></span>
                <div class="form-row node-input-rule-container-row row-full-width">
                    <ol id="node-input-rule-container"></ol>
                    <button type="button" id="node-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnAdd"></span></button> &nbsp;
                    <button type="button" id="node-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnClear"></span></button> &nbsp;
                    <button type="button" id="node-button-sort" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnSort" style="margin-top: 4px;"><i class="fa fa-sort-amount-asc"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnSort"></span></button>
                    <button type="button" id="node-button-export" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnExport" style="margin-top: 4px;"><i class="fa fa-files-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnExport"></span></button>
                    <button type="button" id="node-button-import" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnImport" style="margin-top: 4px;"><i class="fa fa-clipboard"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnImport"></span></button>
                </div>
            </div>
        </div>
        <div id="blind-control-tab-sun-control" style="display:none">
            <!-- sun ######################################################################## -->
            <div class="form-row block-noindent is-to-show-initially">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunControlMode" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row block-noindent" data-i18n="[title]blind-control.placeholder.sunControlMode">
                <label for="node-input-sunControlMode"><i class="fa fa-play-circle"></i> <span data-i18n="blind-control.label.sunControlMode"></span></label>
                <select id="node-input-sunControlMode" class="row-full-width">
                    <option value="0" data-i18n="[html]blind-control.label.sunControlOff"></option>
                    <option value="1" data-i18n="[html]blind-control.label.sunControlMaximize"></option>
                    <option value="3" data-i18n="[html]blind-control.label.sunControlMinimize"></option>
                    <option value="16" data-i18n="[html]blind-control.label.sunControlRestrict"></option>
                </select>
            </div>
            <div class="form-row form-row-sunControlRestriction block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunControlRestriction" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlMaximization block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunControlMaximization" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlMinimization block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunControlMinimization" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlActive block-noindent" data-i18n="[title]blind-control.placeholder.sunTopic">
                <label for="node-input-sunTopic"><i class="fa fa-tasks"></i> <span data-i18n="blind-control.label.sunTopic"></span></label>
                <input type="text" id="node-input-sunTopic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
            </div>
            <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindSlatSun">
                <label for="node-input-sunSlat"><i class="fa fa-slack"></i> <span data-i18n="blind-control.label.blindSlatSun"></span></label>
                <input type="text" id="node-input-sunSlat" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindSlatSun"/>
                <input type="hidden" id="node-input-sunSlatType"/>
            </div>
            <hr class="form-row-sunControlActive" >
            <!-- window ######################################################################## -->
            <div class="form-row form-row-sunControlActive block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.windowAzimuth" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthStart">
                <label for="node-input-windowAzimuthStart"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthStart"></span></label>
                <input type="text" class="row-full-width" id="node-input-windowAzimuthStart" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthStart"/>
                <input type="hidden" id="node-input-windowAzimuthStartType"/>
            </div>
            <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowAzimuthEnd">
                <label for="node-input-windowAzimuthEnd"><i class="fa fa-compass fa-spin"></i> <span data-i18n="blind-control.label.windowAzimuthEnd"></span></label>
                <input type="text" class="row-full-width" id="node-input-windowAzimuthEnd" data-i18n="[placeholder]blind-control.placeholder.windowAzimuthEnd"/>
                <input type="hidden" id="node-input-windowAzimuthEndType"/>
            </div>
            <div class="form-row form-row-sunControlRestriction block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.windowPos" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowTop">
                <label for="node-input-windowTop"><i class="fa fa-arrow-up"></i> <span data-i18n="blind-control.label.windowTop"></span></label>
                <input type="text" class="row-full-width" id="node-input-windowTop" data-i18n="[placeholder]blind-control.placeholder.windowTop"/>
                <input type="hidden" id="node-input-windowTopType"/>
            </div>
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.windowBottom">
                <label for="node-input-windowBottom"><i class="fa fa-arrow-down"></i> <span data-i18n="blind-control.label.windowBottom"></span></label>
                <input type="text" class="row-full-width" id="node-input-windowBottom" data-i18n="[placeholder]blind-control.placeholder.windowBottom"/>
                <input type="hidden" id="node-input-windowBottomType"/>
            </div>
            <!-- sun-restriction ######################################################################## -->
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunCtrlLoF" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunFloorLength">
                <label for="node-input-sunFloorLength"><i class="fa fa-arrows-h"></i> <span data-i18n="blind-control.label.sunFloorLength"></span></label>
                <input type="text" class="row-full-width" id="node-input-sunFloorLength" data-i18n="[placeholder]blind-control.placeholder.sunFloorLength"/>
                <input type="hidden" id="node-input-sunFloorLengthType"/>
            </div>
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunCtrlRestrict" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1-noadd" data-i18n="[title]blind-control.placeholder.sunMinDelta">
                <label for="node-input-sunMinDelta"><i class="fa fa-star-half"></i> <span data-i18n="blind-control.label.sunMinDelta"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-sunMinDelta" data-i18n="[placeholder]blind-control.placeholder.sunMinDelta"/>
            </div>
            <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMin">
                <label for="node-input-blindPosMin"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMin"></span></label>
                <input type="text" id="node-input-blindPosMin" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMin"/>
                <input type="hidden" id="node-input-blindPosMinType"/>
            </div>
            <div class="form-row form-row-sunControlActive block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindLevelMax">
                <label for="node-input-blindPosMax"><i class="fa fa-angle-down"></i> <span data-i18n="blind-control.label.blindLevelMax"></span></label>
                <input type="text" id="node-input-blindPosMax" class="row-full-width" data-i18n="[placeholder]blind-control.placeholder.blindLevelMax"/>
                <input type="hidden" id="node-input-blindPosMaxType"/>
            </div>
            <hr class="form-row-sunControlActive" >
            <!-- oversteering ######################################################################## -->
            <div class="form-row form-row-sunControlActive block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.oversteer" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlActive node-input-oversteer-container-row">
                <ol id="node-input-oversteer-container"></ol>
                <button type="button" id="node-oversteer-button-add" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnAdd" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnAdd"></span></button> &nbsp;
                <button type="button" id="node-oversteer-button-clear" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnClear" style="margin-top: 4px;"><i class="fa fa-eraser"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnClear"></span></button> &nbsp;
                <button type="button" id="node-oversteer-button-export" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnExport" style="margin-top: 4px;"><i class="fa fa-files-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnExport"></span></button>
                <button type="button" id="node-oversteer-button-import" class="rdg-ui-btn red-ui-button red-ui-button-small" data-i18n="[title]blind-control.placeholder.btnImport" style="margin-top: 4px;"><i class="fa fa-clipboard"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.btnImport"></span></button>
            </div>
            <div class="form-row row-oversteerTopic block-noindent" data-i18n="[title]blind-control.placeholder.oversteerTopic">
                <label for="node-input-oversteerTopic"><i class="fa fa-tasks"></i> <span data-i18n="blind-control.label.oversteerTopic"></span></label>
                <input type="text" id="node-input-oversteerTopic" class="row-full-width" data-i18n="[placeholder]node-red:common.label.topic"/>
            </div>
            <hr class="form-row-sunControlRestriction" >
            <!-- advanced ########################################################################## -->
            <div class="form-row form-row-sunControlRestriction block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.sunAdvanced" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlRestriction is-initial-hidden block-indent1" data-i18n="[title]blind-control.placeholder.smoothTime">
                <label for="blind-control-smoothTime"><i class="fa fa-calculator"></i> <span data-i18n="blind-control.label.smoothTime"></span></label>
                <input type="text" class="spinner-time" id="blind-control-smoothTime" data-i18n="[placeholder]blind-control.placeholder.smoothTime" value=""/>
                <select id="blind-control-smoothTime-multiplier" class="node-input-multiplier">
                    <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                    <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                    <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                </select>
                <input type="hidden" id="node-input-smoothTime"/>
            </div>
            <div class="form-row form-row-sunControlRestriction block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.blindPosOffset" class="row-full-width" style="word-wrap:break-word;"></span>
            </div>
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindOpenPosOffset">
                <label for="node-input-blindOpenPosOffset"><i class="fa fa-chevron-circle-up"></i> <span data-i18n="blind-control.label.blindOpenPosOffset"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-blindOpenPosOffset" data-i18n="[placeholder]blind-control.placeholder.blindOpenPosOffset"/>
            </div>
            <div class="form-row form-row-sunControlRestriction block-indent1-noadd" data-i18n="[title]blind-control.placeholder.blindClosedPosOffset">
                <label for="node-input-blindClosedPosOffset"><i class="fa fa-chevron-circle-down"></i> <span data-i18n="blind-control.label.blindClosedPosOffset"></span></label>
                <input type="text" class="spinner-level row-full-width" id="node-input-blindClosedPosOffset" data-i18n="[placeholder]blind-control.placeholder.blindClosedPosOffset"/>
            </div>
        </div>
        <div id="blind-control-tab-output" style="display:none">
            <!-- Output ######################################################################## -->
            <div>
                <label for="node-input-result-container-row"><i class="fa fa-list"></i> <span data-i18n="blind-control.label.resultContainer"></span></label>
                <div class="form-row node-input-result-container-row">
                    <ol id="node-input-result-container"></ol>
                </div>
            </div>
            <hr>
            <!-- Enhanced ######################################################################## -->
            <div class="form-row block-noindent">
                <span><i class="fa fa-cogs"></i> <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.enhanced"></span></span>
            </div>
            <div class="form-row block-noindent spinner-Small" data-i18n="[title]blind-control.placeholder.autoTrigger">
                <label for="node-input-autoTrigger"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.autoTrigger"></span></label>
                <input type="checkbox" id="node-input-autoTrigger" style="width: auto;">
                <span data-i18n="blind-control.label.autoTrigger2"></span>
                <span id="blind-control-autoTriggerTime-edit" class="is-initial-hidden">
                    <input type="text" class="spinner-time" id="blind-control-autoTriggerTime" data-i18n="[placeholder]blind-control.placeholder.autoTriggerTime" value=""/>
                    <select id="blind-control-autoTriggerTime-multiplier" class="node-input-multiplier">
                        <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                        <option value="3600000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.3"></option>
                        <option value="86400000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.4"></option>
                    </select>
                    <input type="hidden" id="node-input-autoTriggerTime"/>
                </span>
            </div>
            <div class="form-row block-noindent spinner-Small" data-i18n="[title]blind-control.placeholder.startDelay2">
                <label for="blind-control-startDelayTime"><i class="fa fa-hourglass-start"></i> <span data-i18n="blind-control.label.startDelay"></span></label>
                <span id="blind-control-startDelayTime-edit">
                    <input type="text" class="spinner-time" id="blind-control-startDelayTime" data-i18n="[placeholder]blind-control.placeholder.startDelay" value=""/>
                    <select id="blind-control-startDelayTime-multiplier" class="node-input-multiplier">
                        <option value="1" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.0"></option>
                        <option value="1000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.1"></option>
                        <option value="60000" data-i18n="node-red-contrib-sun-position/position-config:common.multiplier.2"></option>
                    </select>
                    <input type="hidden" id="node-input-startDelayTime"/>
                </span>
            </div>
            <div class="form-row">
                <label for="node-input-contextStore"><i class="icon-tag"></i> Context Store</label>
                <select id="node-input-contextStore">
                    <option value="">none</option>
                </select>
            </div>
            <div class="form-row block-noindent">
                <span data-i18n="[html]node-red-contrib-sun-position/position-config:ruleCtrl.text.startDelayTime"></span></span>
            </div>
        </div>
    </div>
    <!-- End ######################################################################## -->

    <!-- DIALOG ######################################################################## -->
    <div id="dialog-select-context" class="red-ui-editor" title="Select Channel and Datapoint">
        <div id="config-lookup-tree"></div>
    </div>

    <div id="dialog-edit-rule" class="red-ui-editor" title="Edit Rule">
        <div class="dialog-row">
            <label for="dlg-ip-btctl-rule-name"><i class="fa fa-tag"></i> <span data-i18n="blind-control.label.name"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-name" class="ipalone" data-i18n="[placeholder]blind-control.placeholder.name"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0 node-dialog-condition-container-row">
            <span><i class="fa fa-puzzle-piece"></i> <span id="dlg-ip-btctl-rule-condition-text"></span></span>
            <div class="dlg-ip-btctl-rule-condcontainer">
                <ol id="dlg-ip-btctl-rule-condition-container"></ol>
            </div>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-timeReg">
            <label for="dlg-ip-btctl-rule-timeReg"><i class="fa fa-clock-o"></i> <span data-i18n="blind-control.label.time"></span></label>
            <select id="dlg-ip-btctl-rule-timeReg-operator" class="ipadd dlg-ip-btctl-rule-timeReg-operator" >
            </select>
            <input type="text" id="dlg-ip-btctl-rule-timeReg" class="ipMain dlg-ip-btctl-rule-timeReg" value="" data-i18n="[placeholder]blind-control.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeReg">
            <label for="dlg-ip-btctl-rule-offset-timeReg"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeReg" class="ipMain dlg-ip-btctl-rule-offset-timeReg" value="" data-i18n="[placeholder]blind-control.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeReg" class="ipadd dlg-ip-btctl-rule-multiplier-timeReg" >
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMin">
            <label for="dlg-ip-btctl-rule-timeMin"><i class="fa fa-step-backward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMin"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeMin" class="ipMain dlg-ip-btctl-rule-timeMin" value="" data-i18n="[placeholder]blind-control.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMin">
            <label for="dlg-ip-btctl-rule-offset-timeMin"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset-timeMin"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeMin" class="ipMain dlg-ip-btctl-rule-offset-timeMin" value="" data-i18n="[placeholder]blind-control.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeMin" class="ipadd dlg-ip-btctl-rule-multiplier-timeMin">
            </select>
        </div>
        <div class="dialog-row block-indent1" id="dialog-row-timeMax">
            <label for="dlg-ip-btctl-rule-timeMax"><i class="fa fa-step-forward" aria-hidden="true"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleTimeMax"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-timeMax" class="ipMain dlg-ip-btctl-rule-timeMax" value="" data-i18n="[placeholder]blind-control.placeholder.time"/>
        </div>
        <div class="dialog-row block-indent2" id="dialog-row-offset-timeMax">
            <label for="dlg-ip-btctl-rule-offset-timeMax"><i class="fa fa-plus"></i> <span data-i18n="blind-control.label.offset-timeMax"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-offset-timeMax" class="ipMain dlg-ip-btctl-rule-offset-timeMax" value="" data-i18n="[placeholder]blind-control.placeholder.offset"/>
            <select  id="dlg-ip-btctl-rule-multiplier-timeMax" class="ipadd dlg-ip-btctl-rule-multiplier-timeMax">
            </select>
        </div>
        <div class="dialog-row dialog-row-timeLimits-ph is-to-show-initially" id="dialog-row-timeConstraintsPlaceholder">
            <div class="dlg-ip-btctl-rule-timecontraintctrl" id="dialog-row-timeConstraints-show">
                <button class="dialog-element-clickable" data-i18n="blind-control.label.timeconstraintshow"></button>
            </div>
        </div>
        <div class="dialog-row dialog-row-timeLimits is-initial-hidden" id="dialog-row-timeConstraints">
            <div class="dlg-ip-btctl-rule-timecontraintctrl" id="dialog-row-timeConstraints-hide">
                <button class="dialog-element-clickable" data-i18n="blind-control.label.timeconstrainthide"></button>
            </div>
            <div id="dlg-ip-btctl-rule-timeDays" class="dlg-ip-btctl-rule-days"  data-i18n="[title]blind-control.placeholder.ruleTimeDays">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDays"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.8"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.9"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.10"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.11"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.days.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.days.7"></span></label>
                    </div>
                </div>
            </div>
            <div class="dlg-ip-btctl-rule-limits" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.specialLimits"></div>
                <div style="display:inline-block;">
                    <div>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyEvenDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenDays"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyOddDays"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddDays"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyEvenWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyEvenWeeks"></span></label>
                        <label><input type='checkbox' id="dlg-ip-btctl-rule-timeOnlyOddWeeks"/> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.onlyOddWeeks"></span></label>
                    </div>
                </div>
            </div>
            <div id="dlg-ip-btctl-rule-timeMonths" class="dlg-ip-btctl-rule-months" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;" data-i18n="node-red-contrib-sun-position/position-config:common.label.validForMonths"></div>
                <div style="display:inline-block;">
                    <div>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.0"><input type='checkbox' checked value='0'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.12"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.1"><input type='checkbox' checked value='1'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.13"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.2"><input type='checkbox' checked value='2'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.14"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.3"><input type='checkbox' checked value='3'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.15"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.4"><input type='checkbox' checked value='4'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.16"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.5"><input type='checkbox' checked value='5'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.17"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.6"><input type='checkbox' checked value='6'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.18"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.7"><input type='checkbox' checked value='7'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.19"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.8"><input type='checkbox' checked value='8'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.20"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.9"><input type='checkbox' checked value='9'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.21"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.10"><input type='checkbox' checked value='10'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.22"></span></label>
                        <label data-i18n="[title]node-red-contrib-sun-position/position-config:common.months.11"><input type='checkbox' checked value='11'/> <span data-i18n="node-red-contrib-sun-position/position-config:common.months.23"></span></label>
                    </div>
                </div>
            </div>

            <div id="dlg-ip-btctl-rule-timeDateLimit" class="dlg-ip-btctl-rule-datelimit" style="margin-top:5px;border-top: 1px solid #000;">
                <div style="display:inline-block; vertical-align:top; margin-right:5px;"><i class="fa fa-calendar-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:common.label.validForDates"></span></div>
                <div style="display:inline-block;">
                    <input type="date" id="dlg-ip-btctl-rule-timedatelimit-start" class="ipMain dlg-ip-btctl-rule-timedatelimit" value="" data-i18n="[placeholder]blind-control.placeholder.start" min="2000-01-01" max="2000-12-31"/>
                    <input type="date" id="dlg-ip-btctl-rule-timedatelimit-end" class="ipMain dlg-ip-btctl-rule-timedatelimit" value="" data-i18n="[placeholder]blind-control.placeholder.end" min="2000-01-01" max="2000-12-31"/>
                </div>
            </div>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-level">
            <label for="dlg-ip-btctl-rule-level"><i class="fa fa-angle-down"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleBlindLevel" ></span></label>
            <input type="text" id="dlg-ip-btctl-rule-level" class="ipMain" data-i18n="[placeholder]blind-control.placeholder.level"/>
            <select id="dlg-ip-btctl-rule-level-operator" class="ipadd dlg-ip-btctl-rule-level-operator" >
            </select>
        </div>
        <div class="dialog-row pt-0 is-initial-hidden" id="dialog-row-slatPos">
            <label for="dlg-ip-btctl-rule-slatPos"><i class="fa fa-slack"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleSlat" ></span></label>
            <input type="text" id="dlg-ip-btctl-rule-slatPos" class="ipalone" data-i18n="[placeholder]blind-control.placeholder.slat"/>
        </div>
        <div class="dialog-row pt-0 is-initial-hidden" id="dialog-row-topic" data-i18n="[title]blind-control.placeholder.ruleTopic">
            <label for="dlg-ip-btctl-rule-topic"><i class="fa fa-tasks"></i> <span data-i18n="node-red:common.label.topic"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-topic" class="ipalone" data-i18n="[placeholder]node-red:common.label.topic"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0" id="dialog-hr-overwrite">
        <div class="dialog-row pt-0 is-initial-hidden" id="dialog-row-resetOverwrite" data-i18n="[title]blind-control.placeholder.ruleResetOverwrite">
            <label for="dlg-ip-btctl-rule-resetOverwrite"><i class="fa fa-thumbs-o-down"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleOverwrite"></span></label>
            <input type="checkbox" id="dlg-ip-btctl-rule-resetOverwrite" style="width: auto;"/>
            <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleResetOverwrite"></span>
        </div>
        <div class="dialog-row pt-0 is-initial-hidden" id="dialog-row-importance" data-i18n="[title]blind-control.placeholder.ruleImportance">
            <label for="dlg-ip-btctl-rule-importance"><i class="fa fa-hand-spock-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleImportance"></span></label>
            <input type="text" id="dlg-ip-btctl-rule-importance" class="ipMain" data-i18n="[placeholder]blind-control.placeholder.ruleImportance"/>
        </div>
        <hr class="mt-1 mb-1 pt-0 pb-0">
        <div class="dialog-row pt-0" id="dialog-row-descr">
            <label for="dlg-txt-btctl-rule-descr" class="pb-1"><i class="fa fa-commenting-o"></i> <span data-i18n="node-red-contrib-sun-position/position-config:ruleCtrl.label.ruleDescription" ></span></label>
            <div id="dlg-txt-btctl-rule-descr" class="pl-3" style="word-wrap:break-word;"></div>
        </div>
    </div>
</script>
<style>
    hr { width: 100% }
    .mt-0 { margin-top:0 !important; }
    .mb-0 { margin-bottom:0 !important; }
    .mt-1 { margin-top:0.5rem !important; }
    .mb-1 { margin-bottom:0.5rem !important; }
    .pt-0 { padding-top:0 !important; }
    .pb-0 { padding-bottom:0 !important; }
    .pl-0 { padding-left:0 !important; }
    .pr-0 { padding-right:0 !important; }
    .pt-1 { padding-top:0.5rem !important; }
    .pb-1 { padding-bottom:0.5rem !important; }
    .pl-1 { padding-left:0.5rem !important; }
    .pr-1 { padding-right:0.5rem !important; }
    .pt-2 { padding-top:1.0rem !important; }
    .pb-2 { padding-bottom:1.0rem !important; }
    .pl-2 { padding-left:1.0rem !important; }
    .pr-2 { padding-right:1.0rem !important; }
    .pt-3 { padding-top:1.25rem !important; }
    .pb-3 { padding-bottom:1.25rem !important; }
    .pl-3 { padding-left:1.25rem !important; }
    .pr-3 { padding-right:1.25rem !important; }
    .is-to-show-initially { display:none }
    .is-initial-hidden { display:none }
    .form-row-sunControlActive { display:none }
    .form-row-sunControlRestriction { display:none }
    .form-row-sunControlMaximization { display:none }
    .form-row-sunControlMinimization { display:none }
    .form-tips { width: 90% }
    .block-indent1 {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .block-indent1-noadd {
        float: left;
        min-height: 1px;
        margin-left: 2%; /* 10px; */
        width: 98%
    }
    .input-error {
        border-color: #d6615f !important;
        background-color: #ffcccc !important;
        color: #555 !important;
    }
    .block-indent2 {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-indent2-noadd {
        float: left;
        min-height: 1px;
        margin-left: 4%; /* 20px; */
        width: 96%
    }
    .block-noindent .row-full-width {
        width : calc(100% - 110px);
    }
    .block-indent1 .row-full-width {
        width : calc(100% - 120px);
    }
    .block-indent2 .row-full-width {
        width : calc(100% - 130px);
    }
    .spinner-Small .ui-spinner {
        width : 100px !important;
    }
    .block-noindent .ui-spinner {
        width : calc(100% - 245px);
    }
    .block-indent1 .ui-spinner {
        width : calc(100% - 255px);
    }
    .block-indent2 .ui-spinner {
        width : calc(100% - 265px);
    }
    .block-noindent-noadd .ui-spinner {
        width : calc(100% - 110px);
    }
    .block-indent1-noadd .ui-spinner {
        width : calc(100% - 120px);
    }
    .block-indent2-noadd .ui-spinner {
        width : calc(100% - 130px);
    }
    .indent-time-text {
        /* text-indent:10px; */
        padding-left: 20px;
    }
    .indent-enh-text {
        padding-left: 10px;
    }
    .node-input-multiplier {
        width: 125px;
        max-width: 125px;
        margin-left: 5px;
    }
    .node-input-addOn {
        width: 100px;
        max-width: 100px;
        margin-left: 5px;
    }
    .ui-spinner input {
        border: none !important;
        width: 95% !important;
    }

    .dialog-row {
        clear: both;
        color: #555;
        margin-bottom: 5px;
    }
    .ui-dialog-rdg .ui-dialog-content-rdg {
        padding: 10px 20px 10px 20px !important;
        width: 94% !important;
    }
    .dialog-row label {
        display: inline-block;
        /* width: 9rem; */
        width: 25%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 label {
        /* width: 11rem; */
        width: 23%;
    }
    .dialog-row.block-indent2 label {
        /* width: 13rem; */
        width: 22%;
    }

    .dialog-row .ipalone {
        /* width: calc(90% - 9rem); */
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipMain {
        /* width: calc(60% - 9rem); */
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ipadd {
        /* width: calc(20% - 9rem);*/
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row .ui-spinner {
        width: 20%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent1 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipalone {
        width: 70%;
        margin-bottom: 0px !important;
    }
    .dialog-row.block-indent2 .ipMain {
        width: 45%;
        margin-bottom: 0px !important;
    }
    .dialog-element-clickable {
        user-select: none;
        cursor: pointer;
        touch-action: manipulation;
        display: inline-block;
        /* background: transparent; */
        /* border: 0; */
        vertical-align:top;
        margin-right:5px;
    }
    .dlg-ip-btctl-rule-condcontainer {
        margin-left: 25%;
    }
    .dlg-ip-btctl-rule-timecontraintctrl,
    .dlg-ip-btctl-rule-days,
    .dlg-ip-btctl-rule-limits,
    .dlg-ip-btctl-rule-months,
    .dlg-ip-btctl-rule-datelimit {
        margin-top: 5px;
        margin-left: 30%;
    }
    .dlg-ip-btctl-rule-days label,
    .dlg-ip-btctl-rule-months label {
        max-width: 55px;
    }
    .dlg-ip-btctl-rule-days label,
    .dlg-ip-btctl-rule-limits label,
    .dlg-ip-btctl-rule-months label {
        -webkit-user-select: none;
        -khtml-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
        vertical-align: baseline;
        width: 110px !important;
    }
    .dlg-ip-btctl-rule-days input,
    .dlg-ip-btctl-rule-limits input,
    .dlg-ip-btctl-rule-months input,
    .dlg-ip-btctl-rule-datelimit input {
        width: auto;
        vertical-align: baseline;
    }
    .dlg-ip-btctl-rule-timedatelimit {
        min-width: 140px;
    }
    .rdgtimer-rule-mainblock {
        margin-right: 16px; /*28px;*/
    }
    .rdgtimer-rule-name-span {
        width: 30%; /* width: 120px; */
        float: left;
    }
    .rdgtimer-rule-description-span {
        font-size: 10px;
        margin-left: 30%;
        margin-right: 5px;
    }
    .rdgtimer-rule-finalspan {
        top: 50%;
        position: absolute;
        right: 28px;
        margin-top: -9px;
    }
    .rdgtimer-rule-ctrl-div {
        display: none;
        /* top: 50%; */
        /* position: absolute; */
        /* right: 66px; */
        /* margin-top: -9px; */
        /* float: left; */
    }
    .rdgtimer-rule-row:hover .rdgtimer-rule-ctrl-div {
        display: block;
    }
    .rule-disabled {
        color: lightgrey;
    }
    .rdgtimer-rule-editBtn,
    .rdgtimer-rule-duplicateBtn,
    .rdgtimer-rule-stateBtn {
        position: absolute;
        margin-top: -9px !important;
        top: 50%;
    }
    .rdgtimer-rule-editBtn {
        right: 88px;
    }
    .rdgtimer-rule-duplicateBtn {
        right: 28px;
    }
    .rdgtimer-rule-stateBtn {
        right: 58px;
    }
</style>
